<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Exam Generator v7.0</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8GLJZDKZM9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8GLJZDKZM9');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --brand-primary: #002147;
            --brand-secondary: #005bb5;
            --accent: #D4AF37;
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #6c757d;
            --border-subtle: #e9ecef;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.06);
            --success-bg: #d1e7dd; --success-text: #0f5132;
            --error-bg: #f8d7da; --error-text: #842029;
            --flag-bg: #fff3cd; --flag-text: #856404;
        }

        [data-theme="dark"] {
            --brand-primary: #3b82f6;
            --brand-secondary: #60a5fa;
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --border-subtle: #333;
            --success-bg: #064e3b; --success-text: #6ee7b7;
            --error-bg: #7f1d1d; --error-text: #fca5a5;
            --flag-bg: #451a03; --flag-text: #fcd34d;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; transition: all 0.3s ease; display: flex; flex-direction: column; min-height: 100vh; }
        .main-wrapper { max-width: 900px; margin: 0 auto; position: relative; width: 100%; flex: 1; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--brand-primary); font-weight: 800; letter-spacing: -0.5px; }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-main); font-size: 0.9rem; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: 0.2s; box-shadow: var(--shadow-card); display: flex; align-items: center; height: 36px; font-weight: 600;}
        .icon-btn:hover { transform: translateY(-2px); border-color: var(--brand-primary); color: var(--brand-primary); }

        .module-switcher { display: flex; background: var(--bg-card); padding: 5px; border-radius: 12px; box-shadow: var(--shadow-card); margin-bottom: 25px; border: 1px solid var(--border-subtle); }
        .module-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 700; color: var(--text-sub); transition: 0.2s; }
        .module-btn.active { background: var(--brand-primary); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--brand-primary); display: block; }
        .stat-label { font-size: 0.85rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .panel { background: var(--bg-card); padding: 25px; border-radius: 16px; box-shadow: var(--shadow-card); margin-bottom: 25px; border: 1px solid var(--border-subtle); animation: fadeIn 0.5s ease-out; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--brand-primary); }
        input, select, textarea { width: 100%; padding: 12px 15px; border-radius: 8px; border: 2px solid var(--border-subtle); background: var(--bg-card); color: var(--text-main); font-size: 1rem; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--brand-primary); outline: none; }
        textarea { resize: none; overflow-y: hidden; }

        .source-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--border-subtle); padding-bottom: 10px; }
        .source-tab { cursor: pointer; padding: 5px 10px; font-weight: 600; color: var(--text-sub); opacity: 0.6; transition: 0.2s; border-radius: 6px; }
        .source-tab:hover { opacity: 1; background: rgba(0,0,0,0.03); }
        .source-tab.active { color: var(--brand-primary); opacity: 1; background: rgba(0,33,71,0.05); }

        .drop-zone { border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.01); }
        .drop-zone:hover { border-color: var(--brand-primary); background: rgba(0,33,71,0.03); }
        .file-chip { display: inline-block; background: var(--border-subtle); padding: 4px 10px; border-radius: 15px; margin: 4px; font-size: 0.8rem; }

        .library-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.02); }
        .lib-category { margin-bottom: 15px; }
        .lib-cat-title { font-size: 0.85rem; font-weight: 700; color: var(--brand-primary); text-transform: uppercase; margin-bottom: 5px; padding-left: 5px; border-bottom: 1px solid var(--border-subtle); padding-bottom:2px;}
        .lib-item { display: flex; align-items: center; padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .lib-item:hover { background: var(--bg-card); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lib-item input { width: 18px; height: 18px; margin-right: 10px; cursor:pointer;}

        .btn { padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; transition: transform 0.1s; }
        .btn-primary { background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,33,71,0.3); }
        .btn-secondary { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-subtle); width: auto; padding: 8px 16px; font-size: 0.9rem; margin: 2px; }
        .btn-secondary:hover { border-color: var(--brand-secondary); color: var(--brand-primary); }
        .btn-secondary.active { background: var(--brand-primary); color: white; border-color: var(--brand-primary); }
        .btn-sm { padding: 5px 12px; font-size: 0.85rem; border-radius: 6px; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .toggle-card { background: rgba(0,0,0,0.03); padding: 10px 12px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; border: 1px solid transparent; transition: 0.2s; }
        .toggle-card:hover { border-color: var(--border-subtle); background: rgba(0,0,0,0.05); }
        .toggle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .toggle-header strong { font-size: 0.95rem; color: var(--brand-primary); }
        .toggle-desc { font-size: 0.75rem; color: var(--text-sub); line-height: 1.2; margin-top: 0; }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--brand-primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .q-card { background: var(--bg-card); padding: 30px; border-radius: 12px; box-shadow: var(--shadow-card); margin-bottom: 25px; border-left: 5px solid transparent; scroll-margin-top: 100px; }
        .q-card.flagged { border-left-color: var(--accent); }
        .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; background: var(--border-subtle); color: var(--text-sub); margin-right: 5px; cursor: pointer; transition: 0.2s; }
        .badge:hover { opacity: 0.8; transform: scale(1.05); }
        .badge.hidden-tag { display: none; }
        .flag-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); font-size: 1.2rem; }
        .flag-btn.active { color: var(--accent); }

        .nav-sidebar { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 90; background: var(--bg-card); padding: 10px; border-radius: 20px; box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle); display: none; transition: all 0.3s ease; }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--border-subtle); cursor: pointer; transition: all 0.2s; position: relative; flex-shrink: 0; }
        .nav-dot:hover { transform: scale(1.3); }
        .nav-dot.answered { background: var(--brand-primary); }
        .nav-dot.flagged { box-shadow: 0 0 0 2px var(--accent); }
        .nav-dot.correct { background: #28a745 !important; } 
        .nav-dot.wrong { background: #dc3545 !important; } 
        .nav-dot.partial { background: #fd7e14 !important; } 
        .nav-dot.active-dot { transform: scale(1.6); z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .nav-tooltip { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); background: #333; color: white; padding: 2px 6px; font-size: 0.7rem; border-radius: 4px; opacity: 0; pointer-events: none; white-space: nowrap; z-index: 1000; }
        .nav-dot:hover .nav-tooltip { opacity: 1; }
        
        @media (max-width: 1000px) { .nav-sidebar { position: fixed; bottom: 20px; top: auto; right: 50%; transform: translateX(50%); flex-direction: row; } }

        .saq-intro { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-style: italic; }
        .saq-part { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed var(--border-subtle); }
        .saq-part:last-child { border-bottom: none; }
        .marking-scheme { display: none; background: rgba(0, 128, 0, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--success-text); }
        .mark-point { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 0.9rem; color: var(--success-text); cursor: pointer; }
        .mark-point input { width: 18px; height: 18px; margin-right: 10px; margin-top: 3px; cursor: pointer; flex-shrink: 0;}

        .option-item { border: 2px solid var(--border-subtle); border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .option-item:hover { border-color: var(--brand-secondary); background: rgba(0,33,71,0.02); }
        .option-item.excluded { opacity: 0.5; text-decoration: line-through; background: rgba(0,0,0,0.05); border-color: transparent; }
        .option-item label { padding: 15px; cursor: pointer; width: 100%; display: flex; align-items: center; }
        .option-item input { width: 20px; height: 20px; margin-right: 15px; }
        
        .exclude-btn { background: none; border: none; color: var(--text-sub); font-size: 1.2rem; padding: 0 15px; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .exclude-btn:hover { opacity: 1; color: var(--error-text); transform: scale(1.2); }

        .feedback-box { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; animation: slideDown 0.3s; }
        .feedback-box.correct { background: var(--success-bg); color: var(--success-text); border: 1px solid currentColor; }
        .feedback-box.wrong { background: var(--error-bg); color: var(--error-text); border: 1px solid currentColor; }
        .word-count { font-size: 0.8rem; color: var(--text-sub); display: block; text-align: right; margin-top:5px; }
        .word-count.error { color: var(--error-text); font-weight: bold; }

        #sticky-score { position: sticky; top: 10px; z-index: 100; background: var(--brand-primary); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; }
        
        .filter-matrix { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border-subtle); margin-bottom: 20px; }
        .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; }
        .filter-label { font-size: 0.8rem; font-weight: bold; width: 80px; color: var(--text-sub); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 16px; text-align: center; max-width: 600px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--brand-secondary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: var(--brand-primary); margin: 0 auto 20px; }
        
        .instruction-section { text-align: left; margin-bottom: 20px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 15px; }
        .instruction-section h3 { margin: 0 0 10px 0; color: var(--brand-primary); font-size: 1.1rem; }
        .instruction-section p, .instruction-section li { margin: 5px 0; font-size: 0.95rem; color: var(--text-main); line-height: 1.5; }
        .instruction-section ul { padding-left: 20px; margin: 0; }
        .highlight { color: var(--brand-secondary); font-weight: bold; }
        
        .changelog-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0; margin-top: 10px; font-size: 0.85rem; }
        .changelog-table th { background: var(--brand-primary); color: white; padding: 8px; }
        .changelog-table th:first-child { border-top-left-radius: 8px; }
        .changelog-table th:last-child { border-top-right-radius: 8px; }
        .changelog-table td { border-bottom: 1px solid var(--border-subtle); padding: 8px; vertical-align: top; }
        .changelog-table tr:last-child td { border-bottom: none; }
        .version-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }

        .disclaimer-box { background: var(--flag-bg); color: var(--flag-text); padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-top: 20px; text-align: left; border: 1px solid var(--accent); }
        .footer-credit { text-align: center; margin-top: 30px; color: var(--text-sub); font-size: 0.9rem; font-weight: 500; opacity: 0.7; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <header>
        <h1>Exam Generator <span style="font-size:0.5em; vertical-align:middle; background:var(--accent); color:white; padding:2px 6px; border-radius:4px;">v7.0</span></h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="openErrorReview()" title="Review Mistakes">üìñ Review</button>
            <button class="icon-btn" onclick="openChangelog()" title="Version History">üìú Log</button>
            <button class="icon-btn" onclick="openInstructions()" title="How to use">‚ùì Guide</button>
            <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle Theme">üåì</button>
        </div>
    </header>

    <div id="setup-screen">
        <div class="module-switcher">
            <button id="mod-pom" class="module-btn active" onclick="switchModule('PoM')">PoM (Principles of Medicine)</button>
            <button id="mod-brs" class="module-btn" onclick="switchModule('BRS')">BRS (Bioregulatory Systems)</button>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="stat-value" id="stat-today-count">0</span>
                <span class="stat-label">Questions Today</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-accuracy">0%</span>
                <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-error-bank">0</span>
                <span class="stat-label">SRS Queue</span>
            </div>
        </div>

        <div class="panel">
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="Enter Gemini API Key..." />
            </div>

            <div class="form-group">
                <label>Select Brain</label>
                <select id="model-select">
                    <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash Lite</option>
                    <option value="gemini-3-flash">Gemini 3 Flash</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                </select>
            </div>

            <div class="settings-grid">
                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>Hide Tags</strong>
                        <label class="switch">
                            <input type="checkbox" id="hide-tags-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">No topic clues during exam.</div>
                </div>

                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>SRS Logic</strong>
                        <label class="switch">
                            <input type="checkbox" id="mix-errors-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">Mix in previous mistakes.</div>
                </div>

                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>Application</strong>
                        <label class="switch">
                            <input type="checkbox" id="application-mode-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">A mix of recall and application</div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex:1; min-width: 100px;">
                    <label># SBAQs</label>
                    <input type="number" id="sbaq-count" value="3" min="0" max="10">
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label># VSAQs</label>
                    <input type="number" id="vsaq-count" value="2" min="0" max="10">
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label># SAQs</label>
                    <input type="number" id="saq-count" value="1" min="0" max="3">
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label>Source Material</label>
                <div class="source-tabs">
                    <div class="source-tab" id="tab-upload" onclick="setSourceMode('upload')">üìÇ Upload</div>
                    <div class="source-tab active" id="tab-library" onclick="setSourceMode('library')">‚òÅÔ∏è Library</div>
                </div>
            </div>

            <div id="source-upload-container" class="hidden">
                <div class="drop-zone" onclick="document.getElementById('file-input').click()">
                    <span style="font-size: 2rem;">üìÇ</span><br>
                    <strong>Drop Slides (PPTX/PDF) Here</strong><br>
                    <span style="font-size:0.8rem; color: var(--text-sub);">Extracts Images & Text Automatically</span>
                    <input type="file" id="file-input" multiple accept=".pdf, .txt, .md, image/*, .pptx, .docx, .ppt, .doc" style="display:none" onchange="updateFileList()">
                </div>
                <div id="file-list-display" class="file-list" style="text-align: center;"></div>
                <textarea id="notes-input" placeholder="Or paste text notes here..." style="margin-top:15px; height: 100px;"></textarea>
            </div>

            <div id="source-library-container">
                <div id="library-loading" style="text-align:center; padding:20px; color:var(--text-sub);">Loading Library...</div>
                <div id="library-list" class="library-list hidden"></div>
            </div>
        </div>

        <button onclick="generateExam()" class="btn btn-primary" id="gen-btn">Generate Exam Session</button>
        <div id="loading" class="hidden" style="text-align: center; margin-top: 15px; font-weight: bold; color: var(--brand-primary);">
            Consulting the Examiners... ü§ñ
        </div>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 30px; border-top: 1px solid var(--border-subtle); padding-top: 20px;">
            <button onclick="clearLogs()" class="btn btn-secondary btn-sm" style="color: #842029;">üóëÔ∏è Reset Stats</button>
        </div>
    </div>

    <div id="nav-sidebar" class="nav-sidebar"></div>

    <div id="quiz-screen" class="hidden">
        <div id="sticky-score">
            <div style="display:flex; flex-direction:column; align-items:flex-start; font-size:0.8rem;">
                <span style="font-weight: bold; font-size: 1rem;">Exam Mode</span>
                <span id="timer-display">00:00</span>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="header-score-display" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">-/5</span>
                <button onclick="location.reload()" style="background: white; color: var(--brand-primary); border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">Quit</button>
            </div>
        </div>
        <div id="questions-container"></div>
        <button onclick="submitQuiz()" class="btn btn-primary" id="submit-btn" style="margin-bottom:50px;">Submit Answers</button>
    </div>

    <div id="review-screen" class="hidden">
        <div id="sticky-score" style="display:flex; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-subtle);">
            <span style="font-weight: bold; font-size: 1.2rem;">Mistake Review</span>
            <button onclick="location.reload()" class="btn btn-secondary btn-sm">Back to Dashboard</button>
        </div>
        
        <div class="filter-matrix">
            <div class="filter-row" id="filter-type-row">
                <span class="filter-label">Types:</span>
            </div>
            <div class="filter-row" id="filter-tag-row">
                <span class="filter-label">Topics:</span>
            </div>
        </div>

        <div id="review-container"></div>
        <div style="margin-top: 30px; text-align: center; padding-bottom: 30px;">
            <button onclick="exportMistakesHTML()" class="btn btn-secondary btn-sm">üì• Mistake Bank (HTML)</button>
            <button onclick="exportHistoryHTML()" class="btn btn-secondary btn-sm">üìú Export Full History (HTML)</button>
        </div>
    </div>

    <div class="footer-credit">Created by Arafat Rais</div>
</div>

<div class="modal-overlay" id="generic-modal">
    <div class="modal-content" id="modal-inner-content"></div>
</div>

<script>
    // --- THEME & INIT ---
    function initTheme() { document.documentElement.setAttribute('data-theme', localStorage.getItem('imperial_theme') || 'light'); }
    function toggleTheme() {
        const n = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', n);
        localStorage.setItem('imperial_theme', n);
    }
    initTheme();

    const savedKey = localStorage.getItem('pom_api_key');
    if (savedKey) document.getElementById('api-key').value = savedKey;

    // --- MODULE CONFIG ---
    const MODULES = {
        'PoM': {
            tags: ["Molecular Biology of the Cell", "Haematology", "Immunology & Infection", "Genetics"],
            trainFile: 'training/train_pom.txt',
            storeKey: 'imp'
        },
        'BRS': {
            tags: ["Neurology & Neuroscience", "Psychiatry", "Endocrinology", "Musculoskeletal & Rheumatology", "Cardiovascular and Respiratory", "Dermatology", "Gastroenterology", "Urology & Renal Medicine", "Development and Aging"],
            trainFile: 'training/train_brs.txt',
            storeKey: 'brs'
        }
    };

    let currentModule = localStorage.getItem('active_module') || 'PoM';
    let currentTags = MODULES[currentModule].tags;
    let trainDataCache = "";
    let lectureLibrary = {}; 
    let sourceMode = 'library'; 
    let activeTypeFilters = ['SBAQ', 'VSAQ', 'SAQ'];
    let activeTagFilters = []; 

    function switchModule(modName) {
        currentModule = modName;
        localStorage.setItem('active_module', modName);
        currentTags = MODULES[modName].tags;
        activeTagFilters = [...currentTags];
        
        document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('active'));
        const btnId = modName === 'PoM' ? 'mod-pom' : 'mod-brs';
        const targetBtn = document.getElementById(btnId);
        if(targetBtn) targetBtn.classList.add('active');
        
        updateStats();
        loadLibrary(); 
        fetchTrainingData();
    }

    // Init with logic check to prevent startup crash
    try {
        switchModule(currentModule);
        setSourceMode('library');
    } catch(e) { console.log("Init sequence skipped initial cloud fetch."); }

    async function fetchTrainingData() {
        try {
            const resp = await fetch(MODULES[currentModule].trainFile);
            if(resp.ok) trainDataCache = await resp.text();
            else console.warn("Training data not found for " + currentModule);
        } catch(e) { console.error("Error loading training data", e); }
    }

    async function loadLibrary() {
        const list = document.getElementById('library-list');
        const loader = document.getElementById('library-loading');
        if(!list || !loader) return;
        loader.classList.remove('hidden');
        list.classList.add('hidden');
        list.innerHTML = '';

        try {
            const resp = await fetch('library.json');
            if(!resp.ok) throw new Error("Library file not found");
            const data = await resp.json();
            lectureLibrary = data[currentModule] || {};
            
            if(Object.keys(lectureLibrary).length === 0) {
                list.innerHTML = `<div style="padding:10px; text-align:center; color:#999;">No lectures found for ${currentModule}.</div>`;
            } else {
                for (const [category, lectures] of Object.entries(lectureLibrary)) {
                    let catHTML = `<div class="lib-category"><div class="lib-cat-title">${category}</div>`;
                    lectures.forEach((lec, idx) => {
                        catHTML += `<label class="lib-item">
                            <input type="checkbox" class="lib-check" data-cat="${category}" data-idx="${idx}">
                            ${lec.name}
                        </label>`;
                    });
                    catHTML += `</div>`;
                    list.innerHTML += catHTML;
                }
            }
        } catch(e) {
            list.innerHTML = `<div style="color:red; text-align:center;">Library Load Error: ${e.message}<br><small>If testing locally, please switch to "Upload" mode.</small></div>`;
        } finally {
            loader.classList.add('hidden');
            list.classList.remove('hidden');
        }
    }

    function setSourceMode(mode) {
        sourceMode = mode;
        document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
        const tabId = mode === 'upload' ? 'tab-upload' : 'tab-library';
        const targetTab = document.getElementById(tabId);
        if(targetTab) targetTab.classList.add('active');
        
        document.getElementById('source-upload-container').classList.toggle('hidden', mode !== 'upload');
        document.getElementById('source-library-container').classList.toggle('hidden', mode !== 'library');
    }

    // --- DATA HANDLING ---
    function getHistory() { return JSON.parse(localStorage.getItem(MODULES[currentModule].storeKey + '_hist') || '[]'); }
    function getErrors() { return JSON.parse(localStorage.getItem(MODULES[currentModule].storeKey + '_err') || '[]'); }
    
    function saveHistoryEntry(q, isCorrect) {
        const hist = getHistory();
        hist.push({ timestamp: new Date().toISOString(), question: q.question, isCorrect: isCorrect, type: q.type, tag: q.tag || "Uncategorized" });
        localStorage.setItem(MODULES[currentModule].storeKey + '_hist', JSON.stringify(hist));
        updateStats();
    }

    function saveError(q, userAns) {
        let errs = getErrors();
        let existing = errs.find(e => e.question === q.question);
        if(existing) { existing.userLastAnswer = userAns; existing.timestamp = new Date().toISOString(); existing.repCount = (existing.repCount || 1) + 1; } 
        else { errs.push({ timestamp: new Date().toISOString(), userLastAnswer: userAns, ...q, repCount: 1 }); }
        localStorage.setItem(MODULES[currentModule].storeKey + '_err', JSON.stringify(errs));
        updateStats();
    }
    
    function updateErrorTag(questionText, newTag) {
        let errs = getErrors();
        let e = errs.find(err => err.question === questionText);
        if(e) { e.tag = newTag; localStorage.setItem(MODULES[currentModule].storeKey + '_err', JSON.stringify(errs)); }
    }

    function removeError(questionText) {
        let errs = getErrors();
        errs = errs.filter(e => e.question !== questionText);
        localStorage.setItem(MODULES[currentModule].storeKey + '_err', JSON.stringify(errs));
        updateStats();
    }

    function updateStats() {
        const hist = getHistory();
        const errs = getErrors();
        const todayStr = new Date().toISOString().slice(0,10);
        const todayEntries = hist.filter(h => h.timestamp.startsWith(todayStr));
        const acc = todayEntries.length > 0 ? Math.round((todayEntries.filter(h => h.isCorrect).length / todayEntries.length) * 100) : 0;
        document.getElementById('stat-today-count').innerText = todayEntries.length;
        document.getElementById('stat-accuracy').innerText = acc + "%";
        document.getElementById('stat-error-bank').innerText = errs.length;
    }
    
    // --- FILE PROCESSING ---
    function updateFileList() {
        const input = document.getElementById('file-input');
        const display = document.getElementById('file-list-display');
        display.innerHTML = "";
        for(let f of input.files) display.innerHTML += `<span class="file-chip">üìÑ ${f.name}</span>`;
    }
    
    function blobToBase64(blob) {
        return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result.split(',')[1]);
            r.readAsDataURL(blob);
        });
    }

    async function processPPTX(fileBlob, fileName) {
        const zip = await JSZip.loadAsync(fileBlob);
        let text = `\n--- CONTENT: ${fileName} ---\n`;
        let xmlFiles = Object.keys(zip.files).filter(n => n.match(/(document|slide\d+)\.xml/));
        xmlFiles.sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0));
        for(let x of xmlFiles) {
            const content = await zip.files[x].async("string");
            text += content.replace(/<[^>]+>/g, ' ') + "\n";
        }
        let imgs = [];
        let imgFiles = Object.keys(zip.files).filter(n => n.match(/media\/.*\.(png|jpg|jpeg)$/i));
        for(let img of imgFiles) {
            const blob = await zip.files[img].async("blob");
            const b64 = await blobToBase64(blob);
            imgs.push({ inline_data: { mime_type: blob.type || "image/jpeg", data: b64 } });
        }
        return { text, imgs };
    }

    // --- GENERATION LOGIC ---
    let currentExamData = [];
    let currentMaxScore = 0;
    let currentUserScore = 0;
    let timerInterval;
    let isSubmitted = false;

    async function generateExam() {
        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');
        document.getElementById('gen-btn').disabled = true;

        try {
            const key = document.getElementById('api-key').value;
            if (key) localStorage.setItem('pom_api_key', key);

            const sbaqN = parseInt(document.getElementById('sbaq-count').value);
            const vsaqN = parseInt(document.getElementById('vsaq-count').value);
            const saqN = parseInt(document.getElementById('saq-count').value);
            const mixErrors = document.getElementById('mix-errors-toggle').checked;
            const hideTags = document.getElementById('hide-tags-toggle').checked;
            const appMode = document.getElementById('application-mode-toggle').checked;

            isSubmitted = false;

            let reviewQuestions = [];
            if (mixErrors) {
                const errors = getErrors();
                if(errors.length > 0) {
                    const totalReq = sbaqN + vsaqN + saqN;
                    const reviewCount = Math.min(errors.length, Math.ceil(totalReq * 0.3)); 
                    errors.sort((a,b) => (b.repCount || 1) - (a.repCount || 1));
                    reviewQuestions = errors.slice(0, reviewCount).map(q => ({...q, isReview: true, activeUserAnswer: null}));                }
            }

            let newQuestions = [];
            if (sbaqN + vsaqN + saqN > 0) {
                let parts = [];
                let hasContent = false;

                if (sourceMode === 'upload') {
                    const input = document.getElementById('file-input');
                    const notes = document.getElementById('notes-input').value;
                    if(notes) { parts.push({text: "NOTES:\n"+notes}); hasContent=true; }
                    for(let file of input.files) {
                        const name = file.name.toLowerCase();
                        if(name.endsWith('.pptx') || name.endsWith('.docx')) {
                            const res = await processPPTX(file, file.name);
                            parts.push({text: res.text});
                            parts.push(...res.imgs);
                        } else {
                            const b64 = await blobToBase64(file);
                            parts.push({ inline_data: { mime_type: file.type, data: b64 } });
                        }
                        hasContent = true;
                    }
                } else {
                    const checkboxes = document.querySelectorAll('.lib-check:checked');
                    for(let cb of checkboxes) {
                        const cat = cb.dataset.cat;
                        const idx = cb.dataset.idx;
                        const lecture = lectureLibrary[cat][idx];
                        if (lecture.files && Array.isArray(lecture.files)) {
                            for(let fileUrl of lecture.files) {
                                try {
                                    const resp = await fetch(fileUrl);
                                    const blob = await resp.blob();
                                    const name = fileUrl.split('/').pop().toLowerCase();
                                    if(name.endsWith('.pptx') || name.endsWith('.docx')) {
                                        const res = await processPPTX(blob, name);
                                        parts.push({text: res.text});
                                        parts.push(...res.imgs);
                                    } else {
                                        const b64 = await blobToBase64(blob);
                                        parts.push({ inline_data: { mime_type: blob.type, data: b64 } });
                                    }
                                    hasContent = true;
                                } catch(e) { console.error("Cloud file load failed:", fileUrl); }
                            }
                        }
                    }
                }

                if(!hasContent) throw new Error("Please upload files or select lectures from the library.");

                let modeInstruction = "FOCUS: 100% Direct Recall questions (Definitions, Facts).";
                if(appMode) modeInstruction = "FOCUS: 50% Direct Recall and 50% Application/Vignette style questions.";

                let saqInstruction = "";
                let saqJsonTemplate = "";
                if (saqN > 0) {
                    saqInstruction = `3. SAQ: 'intro', 'parts' (question, marks, model_answer array). Total 10 marks.`;
                    saqJsonTemplate = `,{ "type":"SAQ", "tag":"...", "intro":"...", "parts": [ {"id":1, "question":"...", "marks":2, "model_answer":["Point 1", "Point 2"]}, {"id":2, "question":"...", "marks":3, "model_answer":["..."]} ] }`;
                }

                const prompt = `
                You are an Imperial College London medical examiner. Create exam questions based on content.
                
                CRITICAL - STRICT SCOPE CONTAINMENT: 
                - You must ONLY generate questions based on the specific text and images provided in the 'user' parts of this prompt.
                - DO NOT use your outside medical knowledge to create questions about topics not present in the files.
                - If the files do not mention a specific disease, protein, or pathway, DO NOT ask about it.

                *** CRITICAL - NO VISUAL REFERENCES ***
                - The user interface is TEXT ONLY. The student CANNOT see the original slides or images.
                - DO NOT generate questions that require looking at a diagram, graph, or image (e.g. "What does label A point to?", "Interpret this graph").
                - DO NOT use phrases like "In the accompanying diagram", "As shown in the figure", or "Look at the table below".
                - All necessary information to answer the question MUST be written in the text of the question stem.

                REQUIRED: ${sbaqN} SBAQs, ${vsaqN} VSAQs${saqN > 0 ? `, ${saqN} SAQs` : ''}.
                
                IMPORTANT TAGGING: Assign strictly one of these tags to the "tag" field based on the content: 
                ${JSON.stringify(currentTags)}
                
                CRITICAL RULES FOR QUALITY CONTROL:
                1. DISTRACTORS: Must be of the SAME CATEGORY and DATA TYPE as the correct answer. (e.g. if the answer is a time '20 mins', distractors must be other times '10 mins', '1 hour'. Do NOT use random words).
                2. META-LANGUAGE BAN: NEVER use phrases like "According to the text", "The notes mention". Write as if you are a standard external exam board.
                3. DIFFICULTY: Options must be homogeneous in tone. Avoid "positive" vs "negative" outliers.
                4. EXPLANATION FORMAT: Use HTML tags (<br>, <b>) for formatting. Structure: "<b>Correct:</b> [Reason]. <br><br><b>Why others are wrong:</b>..."
                
                ${modeInstruction}

                TYPES:
                1. SBAQ: Must include 5 options (A-E). "correctAnswer" MUST be the EXACT option text string.
                2. VSAQ: 1-4 words max answer.
                ${saqInstruction}

                *** STRICT SAQ MARKING RULE ***
                You MUST enforce a 1-to-1 ratio between 'marks' and 'model_answer' items:
                - If "marks": 2, the "model_answer" array MUST contain exactly 2 separate strings.
                - If "marks": 4, the "model_answer" array MUST contain exactly 4 separate strings.
                - DO NOT combine multiple points into one string. Split them up so the user gets one checkbox per mark.
                - WRONG: "marks": 2, "model_answer": ["Cell membrane and Nucleus"] (This is only 1 item).
                - CORRECT: "marks": 2, "model_answer": ["Cell membrane", "Nucleus"] (This is 2 items).

                JSON FORMAT ONLY:
                [
                  {"type":"SBAQ", "tag":"...", "question":"...", "options":["A...","B...","C...","D...","E..."], "correctAnswer":"...", "explanation":"..."},
                  {"type":"VSAQ", "tag":"...", "question":"...", "acceptedAnswers":["..."], "explanation":"..."}
                  ${saqJsonTemplate}
                ]`;

                // 3. Send to API
                const finalParts = [{text: prompt}];
                if(trainDataCache) finalParts.push({text: "TRAINING EXAMPLES:\n" + trainDataCache});
                finalParts.push(...parts);

                const model = document.getElementById('model-select').value;
                const apiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: finalParts }] })
                });
                
                const apiData = await apiResp.json();
                
                // FIX FOR ERROR #2 (Reading '0')
                if(apiData.error) throw new Error(apiData.error.message);
                if(!apiData.candidates || apiData.candidates.length === 0) {
                     throw new Error("AI Refused to Generate (Safety Block). Please try again.");
                }

                let txt = apiData.candidates[0].content.parts[0].text;
                
                // FIX FOR ERROR #3 (Unexpected Token / JSON)
                // This logic aggressively finds the start '[' and end ']' of the JSON array
                const first = txt.indexOf('[');
                const last = txt.lastIndexOf(']');
                
                if(first === -1 || last === -1) {
                    throw new Error("AI did not return a valid list of questions. Try again.");
                }
                
                // Cleanly slice ONLY the JSON part, ignoring "Hope this helps" text
                txt = txt.substring(first, last + 1);
                
                try {
                    newQuestions = JSON.parse(txt);
                } catch(e) {
                    console.error("JSON Parse Failed on:", txt);
                    throw new Error("Data corruption in AI response. Please try again.");
                }
            }

            currentExamData = [...reviewQuestions, ...newQuestions];
            // ... (Rest of the function stays the same)

            currentExamData = [...reviewQuestions, ...newQuestions];
            const typeOrder = { 'SBAQ': 1, 'VSAQ': 2, 'SAQ': 3 };
            currentExamData.sort((a,b) => (typeOrder[a.type] || 99) - (typeOrder[b.type] || 99));
            
            renderExam(currentExamData, 'questions-container', false, hideTags);
            startTimer();
            window.scrollTo(0, 0);
        } catch(e) { showCustomAlert("Generation Error", e.message); } finally {
            loading.classList.add('hidden');
            document.getElementById('gen-btn').disabled = false;
        }
    }

    function startTimer() {
        let sec = 0; clearInterval(timerInterval);
        const disp = document.getElementById('timer-display');
        timerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60).toString().padStart(2,'0');
            const s = (sec % 60).toString().padStart(2,'0');
            disp.innerText = `${m}:${s}`;
        }, 1000);
    }

    // --- RENDERING ---
    function renderExam(data, containerId, isReviewMode = false, hideTags = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        currentMaxScore = 0; 

        // 1. Sidebar & Setup
        const nav = document.getElementById('nav-sidebar');
        nav.innerHTML = '';
        
        if(!isReviewMode) {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('review-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('sticky-score').style.display = 'flex';
            document.getElementById('header-score-display').innerText = `0/${currentMaxScore}`;
            
            const submitBtn = document.getElementById('submit-btn');
            if(submitBtn) submitBtn.style.display = isSubmitted ? 'none' : 'block';

            // Sidebar Logic
            nav.style.display = 'flex';
            data.forEach((q, i) => {
                let dotClass = "nav-dot";
                if (isSubmitted) {
                    if (q.type === 'SAQ') {
                         const cardChecks = document.querySelectorAll(`#card-${i} .mark-point input:checked`);
                         const totalChecks = document.querySelectorAll(`#card-${i} .mark-point input`);
                         // Safety check
                         if(totalChecks.length > 0) {
                             if(cardChecks.length === totalChecks.length) dotClass += " correct";
                             else if(cardChecks.length > 0) dotClass += " partial";
                             else dotClass += " wrong";
                         } else { dotClass += " wrong"; }
                    } else if (q.activeUserAnswer) {
                        let isCorrect = false;
                        let corr = q.correctAnswer || (q.acceptedAnswers ? q.acceptedAnswers[0] : "");
                        if(q.type === 'SBAQ' && corr) {
                            const cleanSel = q.activeUserAnswer.toLowerCase().replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                            const cleanCorrect = corr.toLowerCase().replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                            if(cleanSel === cleanCorrect) isCorrect = true;
                        } else if (q.acceptedAnswers) {
                            if(q.acceptedAnswers.some(a => a.toLowerCase().includes(q.activeUserAnswer.toLowerCase()))) isCorrect = true;
                        }
                        dotClass += isCorrect ? " correct" : " wrong";
                    } else { dotClass += " wrong"; }
                } else if (q.activeUserAnswer && (q.activeUserAnswer.length > 0)) {
                    dotClass += " answered";
                }
                nav.innerHTML += `<div class="${dotClass}" id="dot-${i}" onclick="document.getElementById('card-${i}').scrollIntoView({behavior:'smooth'})"><span class="nav-tooltip">Q${i+1}</span></div>`;
            });
            
            // Scroll Spy
            setTimeout(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            document.querySelectorAll('.nav-dot').forEach(d => d.classList.remove('active-dot'));
                            const id = entry.target.id.split('-')[1];
                            const dot = document.getElementById(`dot-${id}`);
                            if(dot) dot.classList.add('active-dot');
                        }
                    });
                }, {threshold: 0.5});
                document.querySelectorAll('.q-card').forEach(c => observer.observe(c));
            }, 100);

        } else {
            nav.style.display = 'none';
        }

        // 2. Render Cards
        data.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'q-card';
            div.id = `card-${i}`;
            
            let tagDisplay = q.tag || "Uncategorized";
            let tagClass = "badge";
            if(hideTags && !isReviewMode) tagClass += " hidden-tag";
            
            let badges = `<span class="badge" style="background:#e9ecef;color:#666">${q.type}</span>`;
            badges += `<span class="${tagClass}" style="background:var(--brand-secondary); color:white; cursor:pointer;" onclick="promptChangeTag(${i})" title="Change Topic">${tagDisplay} ‚úé</span>`;
            if(q.isReview) badges += `<span class="badge" style="background:var(--flag-bg); color:var(--flag-text);">SRS Review</span>`;

            let contentHTML = '';
            const isDisabled = isReviewMode || isSubmitted ? 'disabled' : '';
            const inputAction = (!isReviewMode && !isSubmitted) ? `onchange="markNavAnswered(${i})"` : '';
            
            const getVal = (def = '') => {
                if (isReviewMode && q.userLastAnswer) return q.userLastAnswer;
                if (!isReviewMode && q.activeUserAnswer) return q.activeUserAnswer;
                return def;
            };

            if(q.type === 'SAQ') {
                // --- SAFETY PATCH IS HERE ---
                if (!q.parts || !Array.isArray(q.parts)) {
                    // If parts are missing, show an error box instead of crashing
                    contentHTML = `<div style="color:red; background:#fee; padding:10px; border-radius:5px;">‚ö†Ô∏è <strong>AI Generation Error:</strong> This question was incomplete. Please flag it or ignore it.</div>`;
                } else {
                    currentMaxScore += 10;
                    contentHTML += `<div class="saq-intro">${q.intro || q.question}</div>`;
                    const savedAns = getVal([]); 
                    q.parts.forEach((part, pIndex) => {
                        const val = savedAns[pIndex] || '';
                        const marks = part.marks || 1;
                        const models = part.model_answer || [];
                        contentHTML += `
                        <div class="saq-part">
                            <strong>Part ${pIndex+1} (${marks} marks)</strong><br>
                            ${part.question}<br>
                            <textarea style="margin-top:10px; height:60px;" placeholder="Type answer..." oninput="autoResize(this)" ${inputAction} ${isDisabled}>${val}</textarea>
                            <div id="saq-mark-${i}-${pIndex}" class="marking-scheme" style="${(isReviewMode || isSubmitted) ? 'display:block' : ''}">
                                <strong>Model Answer:</strong><br>
                                ${models.map((point) => `<label class="mark-point"><input type="checkbox" onchange="updateSAQScore(${i})"> ${point}</label>`).join('')}
                            </div>
                        </div>`;
                    });
                }
            } else if(q.type === 'SBAQ') {
                currentMaxScore += 1;
                let opts = q.options || [];
                contentHTML = `<div style="display:grid; gap:10px;">`;
                const userSel = getVal(); 
                opts.forEach((opt, optIndex) => {
                    const val = typeof opt === 'string' ? opt : JSON.stringify(opt);
                    const clean = val.replace(/^[A-E]\.\s*/, '').trim();
                    let isChecked = false;
                    if(userSel) {
                         if(clean.toLowerCase() === userSel.replace(/^[A-E]\.\s*/, '').trim().toLowerCase()) isChecked = true;
                    }
                    contentHTML += `<div class="option-item" id="opt-${i}-${optIndex}" style="${isChecked ? 'border-color:var(--brand-primary); background:rgba(0,33,71,0.05);' : ''}">
                            <label><input type="radio" name="q${i}" value="${clean.replace(/"/g, '&quot;')}" ${isChecked?'checked':''} ${isDisabled} ${inputAction}> ${clean}</label>
                            <button class="exclude-btn" onclick="toggleExclusion(${i}, ${optIndex}, event)">‚úï</button>
                        </div>`;
                });
                contentHTML += `</div>`;
            } else {
                currentMaxScore += 1;
                const val = getVal();
                contentHTML = `<input type="text" id="input-${i}" placeholder="Max 4 words..." value="${val}" onkeyup="checkWordCount(${i})" ${inputAction} ${isDisabled}>
                    <span id="count-${i}" class="word-count">0/4 words</span>`;
            }

            let feedbackContent = '';
            if ((isReviewMode || isSubmitted) && q.type !== 'SAQ') {
                feedbackContent = `<strong>Correct:</strong> ${q.correctAnswer || q.acceptedAnswers}<br><br><strong>Analysis:</strong><br>${q.explanation}`;
            }

            div.innerHTML = `
                <div class="q-header"><div>${badges}</div><button class="flag-btn" onclick="toggleFlag(${i}, this)">üö©</button></div>
                <h3 style="margin-top:0">${i+1}. ${q.type === 'SAQ' ? 'Short Answer Question' : q.question}</h3>
                ${contentHTML}
                <div id="feedback-${i}" class="feedback-box" style="${(isReviewMode || isSubmitted) && q.type !== 'SAQ' ? 'display:block; background:rgba(0,0,0,0.03); color:var(--text-main); border:1px solid var(--border-subtle);' : ''}">${feedbackContent}</div>
            `;
            container.appendChild(div);
        });
        
        if(!isReviewMode) document.getElementById('header-score-display').innerText = `0/${currentMaxScore}`;
    }  
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function checkWordCount(i) {
        const inp = document.getElementById(`input-${i}`);
        const cnt = document.getElementById(`count-${i}`);
        const w = inp.value.trim().split(/\s+/).filter(x=>x).length;
        cnt.innerText = `${w}/4 words`;
        if(w>4) { cnt.classList.add('error'); inp.style.borderColor='var(--error-text)'; }
        else { cnt.classList.remove('error'); inp.style.borderColor='var(--border-subtle)'; }
    }
    function toggleFlag(i, btn) {
        btn.classList.toggle('active');
        document.getElementById(`card-${i}`).classList.toggle('flagged');
        const dot = document.getElementById(`dot-${i}`);
        if(dot) dot.classList.toggle('flagged');
    }
    function toggleExclusion(qIndex, optIndex, event) {
        event.stopPropagation();
        document.getElementById(`opt-${qIndex}-${optIndex}`).classList.toggle('excluded');
    }
    
    function markNavAnswered(i) {
        const dot = document.getElementById(`dot-${i}`);
        if(dot && !isSubmitted) dot.classList.add('answered');
        const q = currentExamData[i];
        if (q.type === 'SBAQ') {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) q.activeUserAnswer = selected.value.trim();
        } else if (q.type === 'VSAQ') {
            q.activeUserAnswer = document.getElementById(`input-${i}`).value;
        } else if (q.type === 'SAQ') {
            q.activeUserAnswer = [];
            const areas = document.querySelectorAll(`#card-${i} textarea`);
            areas.forEach(a => q.activeUserAnswer.push(a.value));
        }
    }

    function promptChangeTag(index) {
        const currentTag = currentExamData[index].tag || "Uncategorized";
        let newTagIndex = currentTags.indexOf(currentTag);
        if (newTagIndex === -1) newTagIndex = 0;
        else newTagIndex = (newTagIndex + 1) % currentTags.length;
        const newTag = currentTags[newTagIndex];
        currentExamData[index].tag = newTag;
        updateErrorTag(currentExamData[index].question, newTag);
        const isReview = !document.getElementById('review-screen').classList.contains('hidden');
        if(isReview) openErrorReview(); 
        else renderExam(currentExamData, 'questions-container', false, document.getElementById('hide-tags-toggle').checked);
    }

    function updateSAQScore(qIndex) {
        const checkboxes = document.querySelectorAll('.mark-point input[type="checkbox"]:checked');
        const finalScore = currentUserScore + checkboxes.length;
        const percent = Math.round((finalScore / currentMaxScore) * 100);
        document.getElementById('header-score-display').innerText = `${finalScore}/${currentMaxScore} (${percent}%)`;
        if (qIndex !== undefined) {
            const cardChecks = document.querySelectorAll(`#card-${qIndex} .mark-point input[type="checkbox"]`);
            const checked = document.querySelectorAll(`#card-${qIndex} .mark-point input[type="checkbox"]:checked`);
            const dot = document.getElementById(`dot-${qIndex}`);
            if(dot) {
                dot.classList.remove('answered', 'wrong', 'correct', 'partial');
                if(checked.length === 0) dot.classList.add('wrong');
                else if(checked.length === cardChecks.length) dot.classList.add('correct');
                else dot.classList.add('partial');
            }
        }
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        isSubmitted = true;
        let score = 0;
        currentExamData.forEach((q, i) => {
            const dot = document.getElementById(`dot-${i}`);
            if(q.type === 'SAQ') {
                const schemes = document.querySelectorAll(`#card-${i} .marking-scheme`);
                schemes.forEach(s => s.style.display = 'block');
                saveError(q, q.activeUserAnswer);
                if(dot) { dot.classList.remove('answered'); dot.classList.add('wrong'); } 
                return; 
            }
            const feedback = document.getElementById(`feedback-${i}`);
            let isCorrect = false;
            let correctAns = q.correctAnswer || (q.acceptedAnswers ? q.acceptedAnswers[0] : "");
            if(q.type === 'SBAQ' && q.activeUserAnswer) {
                const cleanSel = q.activeUserAnswer.toLowerCase().replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                const cleanCorrect = correctAns.toLowerCase().replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                if(cleanSel === cleanCorrect) isCorrect = true;
            } else if (q.type === 'VSAQ' && q.activeUserAnswer) {
                if(q.acceptedAnswers.some(a => a.toLowerCase().includes(q.activeUserAnswer.toLowerCase()))) isCorrect = true;
            }
            if(isCorrect) { score++; removeError(q.question); } 
            else { saveError(q, q.activeUserAnswer || "No Answer"); }
            saveHistoryEntry(q, isCorrect);
            if(dot) { dot.classList.remove('answered'); dot.classList.add(isCorrect ? 'correct' : 'wrong'); }
            feedback.style.display = 'block';
            feedback.className = isCorrect ? 'feedback-box correct' : 'feedback-box wrong';
            feedback.innerHTML = `<strong>${isCorrect?'Correct':'Incorrect'}</strong><br>Answer: ${correctAns}<br><br><strong>Analysis:</strong><br>${q.explanation}`;
            if(!isCorrect && q.type === 'VSAQ') feedback.innerHTML += `<button class="btn btn-secondary" style="margin-top:10px; width:100%" onclick="markCorrect(${i})">Mark as Correct</button>`;
        });
        currentUserScore = score;
        updateSAQScore();
        document.getElementById('submit-btn').style.display = 'none';
        if(!currentExamData.some(q => q.type === 'SAQ')) {
            const pct = Math.round((score/currentMaxScore)*100);
            showResultModal(pct, score, currentMaxScore);
            if(pct > 70) confetti();
        } else { showCustomAlert("Self Marking Required", "Please self-mark the SAQ sections."); }
    }

    function markCorrect(i) {
        currentUserScore++;
        const q = currentExamData[i];
        removeError(q.question);
        document.getElementById(`feedback-${i}`).className = 'feedback-box correct';
        const dot = document.getElementById(`dot-${i}`);
        if(dot) { dot.classList.remove('wrong'); dot.classList.add('correct'); }
        updateSAQScore();
    }

    function showCustomAlert(title, message) {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `<h2 style="color:var(--brand-primary); margin-top:0;">${title}</h2><p style="color:var(--text-main); margin-bottom:25px;">${message}</p><button class="btn btn-primary" onclick="closeGenericModal()">OK</button>`;
        modal.style.display = 'flex';
    }

    function showResultModal(pct, score, max) {
        const modal = document.getElementById('generic-modal');
        document.getElementById('modal-inner-content').innerHTML = `<div class="score-circle">${pct}%</div><h2 style="color:var(--brand-primary);">Session Complete</h2><p style="color:var(--text-sub); margin-bottom:25px;">Score: ${score}/${max}</p><div style="display: flex; gap: 10px;"><button onclick="closeGenericModal()" class="btn btn-secondary" style="flex:1">Review Answers</button><button onclick="location.reload()" class="btn btn-primary" style="flex:1">Next Exam</button></div>`;
        modal.style.display = 'flex';
    }

    function openInstructions() {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0; border-bottom:1px solid #ddd; padding-bottom:10px;">Exam Generator Guide</h2>
            
            <div class="instruction-section">
                <h3>1. Initial Setup</h3>
                <p>This app requires a <strong>Gemini API Key</strong> to function. It's free and easy to get:</p>
                <ul>
                    <li><a href="https://support.google.com/accounts?p=verify_age&sjid=2239933336911860722-EU" target="_blank" class="highlight">Verify your age to Google</a> if you haven't already.</li>
                    <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="highlight">Google AI Studio</a>.</li>
                    <li>Click the blue <strong>"Get API key"</strong> button.</li>
                    <li>Click <strong>"Create API key"</strong>.</li>
                    <li>Copy the long code (starts with "AIza...") and paste it into the "API Key" box on the dashboard.</li>
                </ul>
                <p><em>(Your key will be saved automatically for next time!)</em></p>
            </div>

            <div class="instruction-section">
                <h3>2. Select Module</h3>
                <p>Use the buttons at the top to switch between modules (e.g., <strong>PoM</strong> or <strong>BRS</strong>). This automatically loads the correct:</p>
                <ul>
                    <li>Topic Tags</li>
                    <li>Training Data (for style matching)</li>
                    <li>Cloud Library Content</li>
                </ul>
            </div>
            
            <div class="instruction-section">
                <h3>3. Choose Source Material</h3>
                <p>You can generate questions from two sources:</p>
                <ul>
                    <li><strong>‚òÅÔ∏è Cloud Library:</strong> Browse and select pre-loaded lectures directly from the server.</li>
                    <li><strong>üìÇ Upload:</strong> Drag & drop your own PPTX, PDF, or DOCX files. The app reads text & images locally.</li>
                </ul>
            </div>

            <div class="instruction-section">
                <h3>4. Taking the Exam</h3>
                <p><strong>Navigation:</strong> Use the dots on the right sidebar to jump between questions. They change color based on your results.</p>
                <p><strong>Answering:</strong></p>
                <ul>
                    <li><strong>SBAQ:</strong> Click options. Use the <small>‚úï</small> button to visually cross out wrong answers.</li>
                    <li><strong>SAQ:</strong> These are self-marked. After submitting, tick the marks you achieved based on the Model Answer.</li>
                </ul>
            </div>

            <div class="instruction-section">
                <h3>5. Review & Mistake Bank</h3>
                <p>Every wrong answer is saved to your browser's local storage.</p>
                <ul>
                   <li><strong>Review Mode:</strong> Click the "Review" button in the header to re-test yourself on mistakes.</li>
                   <li><strong>Filters:</strong> In Review Mode, you can filter questions by Type (SBAQ/VSAQ) or Topic Tag.</li>
                   <li><strong>Tag Editor:</strong> Click the colored badge on a question card to correct the topic if the AI labeled it wrong.</li>
                </ul>
            </div>

            <div class="disclaimer-box">
                <strong>‚ö†Ô∏è Disclaimer:</strong><br>
                This tool uses Generative AI. While it is trained on specific course data, hallucinations can occur. Always verify answers against your official lecture notes.
            </div>

            <button class="btn btn-primary" onclick="closeGenericModal()" style="margin-top:20px; width:100%;">Close Guide</button>
        `;
        modal.style.display = 'flex';
    }

    function openChangelog() {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0;">Version History</h2>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table class="changelog-table">
                    <tr><th>Version</th><th>Changes</th></tr>
                    <tr><td><span class="version-badge">7.0</span></td><td>
                        ‚Ä¢ <strong>Module:</strong> Toggle to switch between PoM or BRS mode.<br>
                        ‚Ä¢ <strong>Library:</strong> Can now select preuploaded lecture slides instead of pasting in notes.<br>
                        ‚Ä¢ <strong>Single-View Mode:</strong> Removed due to a number of bugs.
                    </td></tr>
                    <tr><td><span class="version-badge">v6.6</span></td><td>
                        ‚Ä¢ <strong>Application Mode:</strong> New toggle for 50/50 Vignette/Recall mix.<br>
                        ‚Ä¢ <strong>Compact UI:</strong> Settings re-arranged into a horizontal grid.<br>
                        ‚Ä¢ <strong>Refinements:</strong> "Imperial Style" is now always on. Fixed table borders.
                    </td></tr>
                    <tr><td><span class="version-badge">v6.5</span></td><td>
                        ‚Ä¢ <strong>Exclusions:</strong> Visual strikethrough (‚úï) for SBAQs.<br>
                        ‚Ä¢ <strong>Single View:</strong> Integrated bottom navigation.<br>
                        ‚Ä¢ <strong>UI Overhaul:</strong> Floating submit button, integrated toggle view button.
                    </td></tr>
                    <tr><td><span class="version-badge">v6.4</span></td><td>‚Ä¢ <strong>Analytics:</strong> Granular tracking.<br>‚Ä¢ <strong>Bug Fixes:</strong> "Wrong Option" placeholders fixed.</td></tr>
                    <tr><td><span class="version-badge">v6.3</span></td><td>‚Ä¢ <strong>HTML Export:</strong> Faster, cleaner download format.</td></tr>
                    <tr><td><span class="version-badge">v6.2</span></td><td>‚Ä¢ <strong>Strict Scope:</strong> Added negative constraints to prevent AI hallucinations.<br>‚Ä¢ <strong>Custom UI:</strong> Replaced native alerts with styled modals.<br>‚Ä¢ <strong>Onboarding:</strong> Added "How to Use" guide.</td></tr>
                    <tr><td><span class="version-badge">v6.1</span></td><td>‚Ä¢ <strong>State Saving:</strong> Fixed bug where changing tags wiped answers.<br>‚Ä¢ <strong>PDF Engine:</strong> Integrated html2pdf for printable exports.</td></tr>
                    <tr><td><span class="version-badge">v6.0</span></td><td>‚Ä¢ <strong>SRS:</strong> Spaced Repetition logic.<br>‚Ä¢ <strong>Exam Tools:</strong> Timer, Quick Nav Sidebar.<br>‚Ä¢ <strong>Tagging:</strong> Strict topic categorization.<br>‚Ä¢ <strong>0 SAQ Fix:</strong> Logic prevents SAQ generation if count is 0.</td></tr>
                    <tr><td><span class="version-badge">v5.4</span></td><td>‚Ä¢ <strong>SAQ Saving:</strong> SAQ answers/scores now saved to the Error Bank.<br>‚Ä¢ <strong>Filters:</strong> Toolbar added to Review Screen.<br>‚Ä¢ <strong>Auto-Expand:</strong> SAQ text areas grow automatically.</td></tr>
                    <tr><td><span class="version-badge">v5.3</span></td><td>‚Ä¢ <strong>The Golden Rule:</strong> "Scientific Accuracy required, but Scope restricted."<br>‚Ä¢ <strong>Context:</strong> AI knows general medical context but won't test it unless in slides.</td></tr>
                    <tr><td><span class="version-badge">v5.2</span></td><td>‚Ä¢ <strong>No Popups:</strong> Replaced all browser alerts with custom modals.<br>‚Ä¢ <strong>Layout:</strong> Preserved loading spinner positions.</td></tr>
                    <tr><td><span class="version-badge">v5.1</span></td><td>‚Ä¢ <strong>Prefix Stripping:</strong> Removes "A.", "B." from correct answers.<br>‚Ä¢ <strong>Scientific Accuracy:</strong> Prompt updated to differentiate enzyme substrates.</td></tr>
                    <tr><td><span class="version-badge">v5.0</span></td><td>‚Ä¢ <strong>SAQ Support:</strong> Added 10-Mark Multi-Part Questions.<br>‚Ä¢ <strong>Self-Marking:</strong> Users grade themselves via checkboxes.<br>‚Ä¢ <strong>Distractors:</strong> AI instructed to generate plausible wrong options.</td></tr>
                    <tr><td><span class="version-badge">v4.3</span></td><td>‚Ä¢ <strong>Export Errors:</strong> Downloads a "Revision Sheet" style text file.<br>‚Ä¢ <strong>Export History:</strong> Downloads a detailed log of every attempt.</td></tr>
                    <tr><td><span class="version-badge">v4.2</span></td><td>‚Ä¢ <strong>Additive Mixing:</strong> "Mix Errors" adds extra old questions.<br>‚Ä¢ <strong>Review Screen:</strong> Dedicated page to review mistakes with filters.<br>‚Ä¢ <strong>Loading UI:</strong> Improved UX text.</td></tr>
                    <tr><td><span class="version-badge">v4.1</span></td><td>‚Ä¢ <strong>"I Was Right":</strong> Retroactively mark VSAQ correct.<br>‚Ä¢ <strong>Word Counter:</strong> Live "0/4 words" counter for VSAQs.<br>‚Ä¢ <strong>Brain Restore:</strong> Restored full training data.</td></tr>
                    <tr><td><span class="version-badge">v4.0</span></td><td>‚Ä¢ <strong>Modern Dashboard:</strong> Home screen with stats.<br>‚Ä¢ <strong>Smart Mix:</strong> Toggle to mix old errors.<br>‚Ä¢ <strong>Exam Tools:</strong> Added Flag button and Sticky Score.<br>‚Ä¢ <strong>UX:</strong> Custom animated Result Modals.</td></tr>
                    <tr><td><span class="version-badge">v3.6</span></td><td>‚Ä¢ <strong>Model Rotation:</strong> Added rotation logic between Flash models to bypass rate limits.</td></tr>
                    <tr><td><span class="version-badge">v3.5</span></td><td>‚Ä¢ <strong>Answer Search:</strong> Code looks for answers in all possible JSON fields.<br>‚Ä¢ <strong>Explanations:</strong> Mandatory "Explanation:" fields for VSAQs.</td></tr>
                    <tr><td><span class="version-badge">v3.4</span></td><td>‚Ä¢ <strong>Forbidden Rule:</strong> "DO NOT generate True/False questions."<br>‚Ä¢ <strong>Rescue Logic:</strong> Extracts options if AI hides them in stem.<br>‚Ä¢ <strong>Error Feedback:</strong> Explicit error messages.</td></tr>
                    <tr><td><span class="version-badge">v3.3</span></td><td>‚Ä¢ <strong>Force List:</strong> Slices text blocks into separate options.<br>‚Ä¢ <strong>Smart Matching:</strong> Cleans user selection for better grading.<br>‚Ä¢ <strong>Clickable Areas:</strong> Entire white box clickable.</td></tr>
                    <tr><td><span class="version-badge">v3.2</span></td><td>‚Ä¢ <strong>JSON Safety Check:</strong> Detects hidden wrapper objects.<br>‚Ä¢ <strong>Crash Protection:</strong> Try...catch blocks for submission.<br>‚Ä¢ <strong>Missing Answer Handling:</strong> Defaults to placeholder.</td></tr>
                    <tr><td><span class="version-badge">v3.1</span></td><td>‚Ä¢ <strong>Native Support:</strong> JSZip/Mammoth for .pptx/.docx.<br>‚Ä¢ <strong>Media Mining:</strong> Unzips PowerPoint to extract images.<br>‚Ä¢ <strong>Context Aware:</strong> Sends slide text AND images.</td></tr>
                    <tr><td><span class="version-badge">v3.0</span></td><td>‚Ä¢ <strong>Upload Zone:</strong> Support for PDFs/Images.<br>‚Ä¢ <strong>Hybrid Input:</strong> Paste text AND upload files.<br>‚Ä¢ <strong>Base64 Processor:</strong> In-browser file conversion.</td></tr>
                    <tr><td><span class="version-badge">v2.1</span></td><td>‚Ä¢ <strong>Auto-Strip:</strong> Removes "A."/"B." from answer text.<br>‚Ä¢ <strong>Re-Labeling:</strong> Assigns fresh labels after shuffle.<br>‚Ä¢ <strong>Result:</strong> Clean option list display.</td></tr>
                    <tr><td><span class="version-badge">v2.0</span></td><td>‚Ä¢ <strong>Strict Blue Theme:</strong> Professional "Imperial Blue" UI.<br>‚Ä¢ <strong>Dark Mode:</strong> Sun/Moon toggle with memory.<br>‚Ä¢ <strong>Adaptive UI:</strong> High contrast adjustments.</td></tr>
                    <tr><td><span class="version-badge">v1.3</span></td><td>‚Ä¢ <strong>Massive Dataset:</strong> Hardcoded 25 example questions.<br>‚Ä¢ <strong>Model Support:</strong> Updated dropdowns.<br>‚Ä¢ <strong>Reset Tools:</strong> Added "Clear Logs" button.</td></tr>
                    <tr><td><span class="version-badge">v1.2</span></td><td>‚Ä¢ <strong>Hardcoded Examples:</strong> Embedded perfect examples.<br>‚Ä¢ <strong>Crash Prevention:</strong> Target stable API endpoints.<br>‚Ä¢ <strong>Style Toggle:</strong> Added "Use Imperial Style Guide".</td></tr>
                    <tr><td><span class="version-badge">v1.1</span></td><td>‚Ä¢ <strong>Automatic Logging:</strong> Questions saved in browser.<br>‚Ä¢ <strong>Error Tracking:</strong> Incorrect list.<br>‚Ä¢ <strong>Review Mode:</strong> Retry wrong answers.<br>‚Ä¢ <strong>Duplicate Check:</strong> Prevent repetition.</td></tr>
                    <tr><td><span class="version-badge">v1.0</span></td><td>‚Ä¢ <strong>Launch:</strong> Core SBAQ/VSAQ generation logic.<br>‚Ä¢ <strong>Prompt Engineering:</strong> Initial parameters.<br>‚Ä¢ <strong>Backend:</strong> Gemini API integration.<br>‚Ä¢ <strong>Controls:</strong> Quantity selectors.</td></tr>
                </table>
            </div>
            <button class="btn btn-primary" onclick="closeGenericModal()" style="margin-top:20px; width:100%;">Close</button>
        `;
        modal.style.display = 'flex';
    }

    function openErrorReview() {
        const e = getErrors();
        if(!e.length) return showCustomAlert("Clean Slate", "No mistakes recorded yet!");
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('review-screen').classList.remove('hidden');
        if(activeTagFilters.length === 0) activeTagFilters = [...currentTags];
        renderFilterButtons();
        applyFilters();
    }

    function renderFilterButtons() {
        let typeHTML = `<button class="btn btn-secondary btn-sm ${activeTypeFilters.length===3?'active':''}" onclick="toggleTypeFilter('ALL')">All</button>`;
        ['SBAQ', 'VSAQ', 'SAQ'].forEach(t => { typeHTML += `<button class="btn btn-secondary btn-sm ${activeTypeFilters.includes(t)?'active':''}" onclick="toggleTypeFilter('${t}')">${t}</button>`; });
        document.getElementById('filter-type-row').innerHTML = `<span class="filter-label">Types:</span> ${typeHTML}`;
        let tagHTML = `<button class="btn btn-secondary btn-sm ${activeTagFilters.length===currentTags.length?'active':''}" onclick="toggleTagFilter('ALL')">All</button>`;
        currentTags.forEach(t => { const shortTag = t.split(' ')[0]; tagHTML += `<button class="btn btn-secondary btn-sm ${activeTagFilters.includes(t)?'active':''}" onclick="toggleTagFilter('${t}')" title="${t}">${shortTag}</button>`; });
        document.getElementById('filter-tag-row').innerHTML = `<span class="filter-label">Topics:</span> ${tagHTML}`;
    }

    function toggleTypeFilter(val) {
        if(val === 'ALL') activeTypeFilters = activeTypeFilters.length === 3 ? [] : ['SBAQ', 'VSAQ', 'SAQ'];
        else { if(activeTypeFilters.includes(val)) activeTypeFilters = activeTypeFilters.filter(x => x !== val); else activeTypeFilters.push(val); }
        renderFilterButtons(); applyFilters();
    }

    function toggleTagFilter(val) {
        if(val === 'ALL') activeTagFilters = activeTagFilters.length === currentTags.length ? [] : [...currentTags];
        else { if(activeTagFilters.includes(val)) activeTagFilters = activeTagFilters.filter(x => x !== val); else activeTagFilters.push(val); }
        renderFilterButtons(); applyFilters();
    }

    function applyFilters() {
        const filtered = getErrors().filter(q => activeTypeFilters.includes(q.type) && (activeTagFilters.includes(q.tag || "Uncategorized") || activeTagFilters.length === currentTags.length));
        currentExamData = filtered; 
        renderExam(filtered, 'review-container', true, false);
    }

        function exportMistakesHTML() {
    const errs = getErrors();
    if (!errs.length) {
        return showCustomAlert("Empty", "No mistakes to export.");
    }

    let html = '<html><head><meta charset="UTF-8"><title>' +
        currentModule + ' Mistake Bank</title>' +
        '<style>' +
        "body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;max-width:800px;margin:0 auto;line-height:1.6;}" +
        "h1{color:#002147;border-bottom:2px solid #002147;padding-bottom:10px;}" +
        ".question-card{border:1px solid #ddd;padding:20px;border-radius:8px;margin-bottom:30px;page-break-inside:avoid;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05);}" +
        ".badges{margin-bottom:10px;font-size:0.85em;}" +
        ".badge{display:inline-block;padding:3px 8px;border-radius:4px;margin-right:5px;font-weight:bold;}" +
        ".badge-type{background:#e9ecef;color:#555;}" +
        ".badge-tag{background:#d4af37;color:white;}" +
        ".user-ans{color:#842029;font-weight:bold;}" +
        ".correct-ans{color:#0f5132;font-weight:bold;}" +
        ".explanation{background:#f8f9fa;padding:15px;border-left:4px solid #002147;margin-top:15px;border-radius:4px;}" +
        "ul{margin:5px 0;padding-left:20px;}" +
        '</style></head><body>';

    html += '<h1>' + currentModule + ' Mistake Bank</h1>';
    html += '<p>Generated on ' + new Date().toLocaleDateString() + '</p>';

    errs.forEach(function(e, i) {
        let optionsHTML = '';
        if (e.type === 'SBAQ' && e.options) {
            optionsHTML = '<div><strong>Options:</strong><ul>';
            e.options.forEach(function(o) {
                optionsHTML += '<li>' + o + '</li>';
            });
            optionsHTML += '</ul></div>';
        }

        let userAnsDisplay = e.userLastAnswer;
        if (Array.isArray(userAnsDisplay)) {
            userAnsDisplay = '<ol>';
            userAnsDisplay += userAnsDisplay.map(function(a){ return '<li>' + (a || '(No answer)') + '</li>'; }).join('');
            userAnsDisplay += '</ol>';
        } else if (!userAnsDisplay) {
            userAnsDisplay = '(No answer recorded)';
        }

        let correctDisplay = e.correctAnswer;
        if (!correctDisplay && Array.isArray(e.acceptedAnswers)) {
            correctDisplay = e.acceptedAnswers.join(', ');
        }

        let qTitle = e.question;
        if (e.type === 'SAQ') {
            qTitle = e.intro || e.question || 'Short Answer Question';
            if (e.parts) {
                correctDisplay = '<div><strong>Model Answers:</strong><br>';
                correctDisplay += e.parts.map(function(p, idx){
                    return '<em>Part ' + (idx + 1) + ':</em> ' + p.model_answer.join('; ');
                }).join('<br>');
                correctDisplay += '</div>';
            }
        }

        html += '<div class="question-card">';
        html +=   '<div class="badges">' +
                  '<span class="badge badge-type">' + e.type + '</span>' +
                  '<span class="badge badge-tag">' + (e.tag || 'Uncategorized') + '</span>' +
                  '</div>';
        html +=   '<h3>' + (i + 1) + '. ' + qTitle + '</h3>';
        html +=   optionsHTML;
        html +=   '<p><strong>You Answered:</strong> <span class="user-ans">' + userAnsDisplay + '</span></p>';
        html +=   '<p><strong>Correct Answer:</strong> <span class="correct-ans">' + (correctDisplay || '') + '</span></p>';
        html +=   '<div class="explanation"><strong>Explanation:</strong><br>' + (e.explanation || '') + '</div>';
        html += '</div>';
    });

    html += '</body></html>';

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentModule + '_Mistake_Bank.html';
    a.click();
}

    function exportHistoryHTML() {
    const hist = getHistory();
    if (!hist.length) {
        return showCustomAlert("Empty", "No history to export.");
    }

    let html = '<html><head><meta charset="UTF-8"><title>' +
        currentModule + ' Exam History</title>' +
        '<style>' +
        "body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;max-width:900px;margin:0 auto;}" +
        "h1{color:#002147;}" +
        "table{width:100%;border-collapse:collapse;margin-top:20px;}" +
        "th{background:#002147;color:white;text-align:left;padding:12px;}" +
        "td{border-bottom:1px solid #ddd;padding:10px;font-size:0.9em;}" +
        "tr:nth-child(even){background-color:#f9f9f9;}" +
        ".correct{color:#0f5132;font-weight:bold;background:#d1e7dd;padding:2px 6px;border-radius:4px;}" +
        ".wrong{color:#842029;font-weight:bold;background:#f8d7da;padding:2px 6px;border-radius:4px;}" +
        '</style></head><body>';

    html += '<h1>' + currentModule + ' Exam History</h1>';
    html += '<table><tr><th>Date</th><th>Type</th><th>Question</th><th>Result</th></tr>';

    hist.forEach(function(h) {
        const dateStr = new Date(h.timestamp).toLocaleDateString();
        const resClass = h.isCorrect ? 'correct' : 'wrong';
        const resText = h.isCorrect ? 'Correct' : 'Wrong';

        html += '<tr>' +
                '<td>' + dateStr + '</td>' +
                '<td>' + h.type + '</td>' +
                '<td>' + h.question + '</td>' +
                '<td><span class="' + resClass + '">' + resText + '</span></td>' +
                '</tr>';
    });

    html += '</table></body></html>';

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentModule + '_Exam_History.html';
    a.click();
}
  
    
    function closeGenericModal() { document.getElementById('generic-modal').style.display = 'none'; }
</script>
</body>
</html>