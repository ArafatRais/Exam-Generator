<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoM Exam Generator v6.6</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8GLJZDKZM9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8GLJZDKZM9');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --brand-primary: #002147;
            --brand-secondary: #005bb5;
            --accent: #D4AF37;
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #6c757d;
            --border-subtle: #e9ecef;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.06);
            --success-bg: #d1e7dd; --success-text: #0f5132;
            --error-bg: #f8d7da; --error-text: #842029;
            --flag-bg: #fff3cd; --flag-text: #856404;
        }

        [data-theme="dark"] {
            --brand-primary: #3b82f6;
            --brand-secondary: #60a5fa;
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --border-subtle: #333;
            --success-bg: #064e3b; --success-text: #6ee7b7;
            --error-bg: #7f1d1d; --error-text: #fca5a5;
            --flag-bg: #451a03; --flag-text: #fcd34d;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; transition: all 0.3s ease; display: flex; flex-direction: column; min-height: 100vh; }
        .main-wrapper { max-width: 900px; margin: 0 auto; position: relative; width: 100%; flex: 1; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { margin: 0; color: var(--brand-primary); font-weight: 800; letter-spacing: -0.5px; }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-main); font-size: 1rem; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: 0.2s; box-shadow: var(--shadow-card); display: flex; align-items: center; justify-content: center; height: 40px;}
        .icon-btn:hover { transform: translateY(-2px); border-color: var(--brand-primary); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--brand-primary); display: block; }
        .stat-label { font-size: 0.85rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .panel { background: var(--bg-card); padding: 25px; border-radius: 16px; box-shadow: var(--shadow-card); margin-bottom: 25px; border: 1px solid var(--border-subtle); animation: fadeIn 0.5s ease-out; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--brand-primary); }
        input, select, textarea { width: 100%; padding: 12px 15px; border-radius: 8px; border: 2px solid var(--border-subtle); background: var(--bg-card); color: var(--text-main); font-size: 1rem; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--brand-primary); outline: none; }
        
        textarea { resize: none; overflow-y: hidden; }

        .drop-zone { border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.01); }
        .drop-zone:hover { border-color: var(--brand-primary); background: rgba(0,33,71,0.03); }
        .file-chip { display: inline-block; background: var(--border-subtle); padding: 4px 10px; border-radius: 15px; margin: 4px; font-size: 0.8rem; }

        .btn { padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; transition: transform 0.1s; }
        .btn-primary { background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,33,71,0.3); }
        .btn-secondary { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-subtle); width: auto; padding: 8px 16px; font-size: 0.9rem; margin: 2px; }
        .btn-secondary:hover { border-color: var(--brand-secondary); color: var(--brand-primary); }
        .btn-secondary.active { background: var(--brand-primary); color: white; border-color: var(--brand-primary); }
        
        .btn-sm { padding: 5px 12px; font-size: 0.85rem; border-radius: 6px; }

        /* Compact Toggles - TIGHTENED */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        
        .toggle-card { 
            background: rgba(0,0,0,0.03); 
            padding: 12px 15px; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .toggle-card:hover { border-color: var(--border-subtle); background: rgba(0,0,0,0.05); }

        .toggle-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2px;
        }
        
        .toggle-header strong { font-size: 0.95rem; color: var(--brand-primary); }

        .toggle-desc { 
            font-size: 0.75rem; 
            color: var(--text-sub); 
            line-height: 1.2; 
            margin-top: 0;
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--brand-primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .q-card { background: var(--bg-card); padding: 30px; border-radius: 12px; box-shadow: var(--shadow-card); margin-bottom: 25px; border-left: 5px solid transparent; scroll-margin-top: 100px; }
        .q-card.flagged { border-left-color: var(--accent); }
        .q-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; background: var(--border-subtle); color: var(--text-sub); margin-right: 5px; cursor: pointer; transition: 0.2s; }
        .badge:hover { opacity: 0.8; transform: scale(1.05); }
        .badge.hidden-tag { display: none; }

        .flag-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); font-size: 1.2rem; }
        .flag-btn.active { color: var(--accent); }

        /* NAV SIDEBAR DEFAULT (RIGHT) */
        .nav-sidebar { 
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%); 
            display: flex; flex-direction: column; gap: 8px; z-index: 90; 
            background: var(--bg-card); padding: 10px; border-radius: 20px; 
            box-shadow: var(--shadow-card); border: 1px solid var(--border-subtle); 
            display: none; transition: all 0.3s ease; 
        }
        
        /* NAV SIDEBAR BOTTOM (SINGLE VIEW) */
        .nav-sidebar.bottom-mode { 
            right: 50%; top: auto; bottom: 20px; 
            transform: translateX(50%); 
            flex-direction: row; 
            align-items: center;
            width: auto; max-width: 90%; 
            overflow-x: auto; 
            padding: 10px 15px; 
            height: auto;
            max-height: 60px;
        }

        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--border-subtle); cursor: pointer; transition: all 0.2s; position: relative; flex-shrink: 0; }
        .nav-dot:hover { transform: scale(1.3); }
        .nav-dot.answered { background: var(--brand-primary); }
        .nav-dot.flagged { box-shadow: 0 0 0 2px var(--accent); }
        .nav-dot.correct { background: #28a745 !important; } 
        .nav-dot.wrong { background: #dc3545 !important; } 
        .nav-dot.partial { background: #fd7e14 !important; } 
        .nav-dot.active-dot { transform: scale(1.6); z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .nav-arrow { background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; padding: 0 10px; display: none; line-height: 1; opacity: 0.7; margin-bottom: -5px;}
        .nav-arrow:hover { opacity: 1; transform: scale(1.2); color: var(--brand-primary); }
        .nav-sidebar.bottom-mode .nav-arrow { display: block; }

        .nav-tooltip { 
            position: absolute; right: 25px; top: 50%; transform: translateY(-50%); 
            background: #333; color: white; padding: 2px 6px; font-size: 0.7rem; 
            border-radius: 4px; opacity: 0; pointer-events: none; white-space: nowrap; z-index: 1000; 
        }
        /* Fix tooltips appearing under bottom bar */
        .nav-sidebar.bottom-mode .nav-tooltip { 
            top: auto; bottom: 45px; right: auto; left: 50%; 
            transform: translateX(-50%); 
        }
        .nav-dot:hover .nav-tooltip { opacity: 1; }

        /* FLOATING ACTION BUTTON (SUBMIT) */
        .fab-submit { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--brand-secondary); color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 1.5rem; cursor: pointer; display: none; z-index: 100; transition: transform 0.2s; align-items: center; justify-content: center;}
        .fab-submit:hover { transform: scale(1.1); background: var(--brand-primary); }

        @media (max-width: 1000px) {
            .nav-sidebar { position: fixed; bottom: 20px; top: auto; right: 50%; transform: translateX(50%); flex-direction: row; }
        }

        /* SAQ STYLES */
        .saq-intro { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-style: italic; }
        .saq-part { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed var(--border-subtle); }
        .saq-part:last-child { border-bottom: none; }
        .marking-scheme { display: none; background: rgba(0, 128, 0, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--success-text); }
        .mark-point { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 0.9rem; color: var(--success-text); cursor: pointer; }
        .mark-point input { width: 18px; height: 18px; margin-right: 10px; margin-top: 3px; cursor: pointer; flex-shrink: 0;}

        .option-item { border: 2px solid var(--border-subtle); border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .option-item:hover { border-color: var(--brand-secondary); background: rgba(0,33,71,0.02); }
        .option-item.excluded { opacity: 0.5; text-decoration: line-through; background: rgba(0,0,0,0.05); border-color: transparent; }
        .option-item label { padding: 15px; cursor: pointer; width: 100%; display: flex; align-items: center; }
        .option-item input { width: 20px; height: 20px; margin-right: 15px; }
        
        .exclude-btn { background: none; border: none; color: var(--text-sub); font-size: 1.2rem; padding: 0 15px; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .exclude-btn:hover { opacity: 1; color: var(--error-text); transform: scale(1.2); }

        .feedback-box { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; animation: slideDown 0.3s; }
        .feedback-box.correct { background: var(--success-bg); color: var(--success-text); border: 1px solid currentColor; }
        .feedback-box.wrong { background: var(--error-bg); color: var(--error-text); border: 1px solid currentColor; }
        .word-count { font-size: 0.8rem; color: var(--text-sub); display: block; text-align: right; margin-top:5px; }
        .word-count.error { color: var(--error-text); font-weight: bold; }

        #sticky-score { position: sticky; top: 10px; z-index: 100; background: var(--brand-primary); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; }
        
        .nav-controls { display: none; gap: 10px; } 
        
        /* Filter Menu Matrix */
        .filter-matrix { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border-subtle); margin-bottom: 20px; }
        .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; }
        .filter-label { font-size: 0.8rem; font-weight: bold; width: 80px; color: var(--text-sub); }

        /* UNIFIED MODAL STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 16px; text-align: center; max-width: 600px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--brand-secondary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: var(--brand-primary); margin: 0 auto 20px; }
        
        /* Instructions & Changelog */
        .instruction-section { text-align: left; margin-bottom: 20px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 15px; }
        .instruction-section:last-child { border-bottom: none; }
        .instruction-section h3 { margin: 0 0 10px 0; color: var(--brand-primary); font-size: 1.1rem; }
        .instruction-section p, .instruction-section li { margin: 5px 0; font-size: 0.95rem; color: var(--text-main); line-height: 1.5; }
        .instruction-section ul { padding-left: 20px; margin: 0; }
        .highlight { color: var(--brand-secondary); font-weight: bold; }
        
        .changelog-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0; margin-top: 10px; font-size: 0.85rem; }
        .changelog-table th { background: var(--brand-primary); color: white; padding: 8px; }
        .changelog-table th:first-child { border-top-left-radius: 8px; }
        .changelog-table th:last-child { border-top-right-radius: 8px; }
        .changelog-table td { border-bottom: 1px solid var(--border-subtle); padding: 8px; vertical-align: top; }
        .changelog-table tr:last-child td { border-bottom: none; }
        .version-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }

        .disclaimer-box { background: var(--flag-bg); color: var(--flag-text); padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-top: 20px; text-align: left; border: 1px solid var(--accent); }

        .footer-credit { text-align: center; margin-top: 30px; color: var(--text-sub); font-size: 0.9rem; font-weight: 500; opacity: 0.7; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <header>
        <h1>PoM Exam Generator <span style="font-size:0.5em; vertical-align:middle; background:var(--accent); color:white; padding:2px 6px; border-radius:4px;">v6.6</span></h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="openChangelog()" title="Version History">üìú Log</button>
            <button class="icon-btn" onclick="openInstructions()" title="How to use">‚ùì Guide</button>
            <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle Theme">üåì</button>
        </div>
    </header>

    <div id="setup-screen">
        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="stat-value" id="stat-today-count">0</span>
                <span class="stat-label">Questions Today</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-accuracy">0%</span>
                <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-error-bank">0</span>
                <span class="stat-label">SRS Queue</span>
            </div>
        </div>

        <div class="panel">
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="Enter Gemini API Key..." />
            </div>

            <div class="form-group">
                <label>Select Brain</label>
                <select id="model-select">
                    <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash Lite</option>
                    <option value="gemini-3-flash">Gemini 3 Flash</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                </select>
            </div>

            <div class="settings-grid">
                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>Hide Tags</strong>
                        <label class="switch">
                            <input type="checkbox" id="hide-tags-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">No topic clues during exam.</div>
                </div>

                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>SRS Logic</strong>
                        <label class="switch">
                            <input type="checkbox" id="mix-errors-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">Mix in previous mistakes.</div>
                </div>

                <div class="toggle-card">
                    <div class="toggle-header">
                        <strong>Application</strong>
                        <label class="switch">
                            <input type="checkbox" id="application-mode-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-desc">A mix of recall and application</div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex:1; min-width: 100px;">
                    <label># SBAQs</label>
                    <input type="number" id="sbaq-count" value="3" min="0" max="10">
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label># VSAQs</label>
                    <input type="number" id="vsaq-count" value="2" min="0" max="10">
                </div>
                <div style="flex:1; min-width: 100px;">
                    <label># SAQs</label>
                    <input type="number" id="saq-count" value="1" min="0" max="3">
                </div>
            </div>
        </div>

        <div class="panel">
            <label>Upload Materials</label>
            <div class="drop-zone" onclick="document.getElementById('file-input').click()">
                <span style="font-size: 2rem;">üìÇ</span><br>
                <strong>Drop Slides (PPTX/PDF) Here</strong><br>
                <span style="font-size:0.8rem; color: var(--text-sub);">Extracts Images & Text Automatically</span>
                <input type="file" id="file-input" multiple accept=".pdf, .txt, .md, image/*, .pptx, .docx, .ppt, .doc" style="display:none" onchange="updateFileList()">
            </div>
            <div id="file-list-display" class="file-list" style="text-align: center;"></div>
            <textarea id="notes-input" placeholder="Or paste text notes here..." style="margin-top:15px; height: 100px;"></textarea>
        </div>

        <button onclick="generateExam()" class="btn btn-primary" id="gen-btn">Generate Exam Session</button>
        <div id="loading" class="hidden" style="text-align: center; margin-top: 15px; font-weight: bold; color: var(--brand-primary);">
            Consulting the Examiners... ü§ñ
        </div>
        
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 30px; border-top: 1px solid var(--border-subtle); padding-top: 20px;">
            <button onclick="clearLogs()" class="btn btn-secondary btn-sm" style="color: #842029;">üóëÔ∏è Reset All</button>
            <button onclick="openErrorReview()" class="btn btn-secondary btn-sm">üìñ Review Mistakes</button>
        </div>
    </div>

    <div id="nav-sidebar" class="nav-sidebar"></div>

    <button id="floating-submit" class="fab-submit" onclick="submitQuiz()" title="Submit All Answers">‚úì</button>

    <div id="quiz-screen" class="hidden">
        <div id="sticky-score">
            <div style="display:flex; flex-direction:column; align-items:flex-start; font-size:0.8rem;">
                <span style="font-weight: bold; font-size: 1rem;">Exam Mode</span>
                <span id="timer-display">00:00</span>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="header-score-display" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">-/5</span>
                <button onclick="toggleViewMode()" class="btn-secondary btn-sm" id="view-toggle-btn" title="Toggle Single/List View">Toggle View</button>
                <button onclick="location.reload()" style="background: white; color: var(--brand-primary); border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">Quit</button>
            </div>
        </div>
        <div id="questions-container"></div>
        <button onclick="submitQuiz()" class="btn btn-primary" id="submit-btn">Submit Answers</button>
    </div>

    <div id="review-screen" class="hidden">
        <div id="sticky-score" style="display:flex; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-subtle);">
            <span style="font-weight: bold; font-size: 1.2rem;">Mistake Review</span>
            <button onclick="location.reload()" class="btn btn-secondary btn-sm">Back to Dashboard</button>
        </div>
        
        <div class="filter-matrix">
            <div class="filter-row" id="filter-type-row">
                <span class="filter-label">Types:</span>
            </div>
            <div class="filter-row" id="filter-tag-row">
                <span class="filter-label">Topics:</span>
            </div>
        </div>

        <div id="review-container"></div>
        <div style="margin-top: 30px; text-align: center; padding-bottom: 30px;">
            <button onclick="exportMistakesHTML()" class="btn btn-secondary btn-sm">üì• Mistake Bank (HTML)</button>
            <button onclick="exportHistoryHTML()" class="btn btn-secondary btn-sm">üìú Export Full History (HTML)</button>
        </div>
    </div>

    <div class="footer-credit">Created by Arafat Rais</div>
</div>

<div class="modal-overlay" id="generic-modal">
    <div class="modal-content" id="modal-inner-content">
        </div>
</div>

<script>
    function initTheme() { document.documentElement.setAttribute('data-theme', localStorage.getItem('imperial_theme') || 'light'); }
    function toggleTheme() {
        const n = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', n);
        localStorage.setItem('imperial_theme', n);
    }
    initTheme();

    // Init API Key (Auto-Load)
    const savedKey = localStorage.getItem('pom_api_key');
    if (savedKey) {
        document.getElementById('api-key').value = savedKey;
    }

    const VALID_TAGS = ["Molecular Biology of the Cell", "Haematology", "Immunology & Infection", "Genetics"];
    const VALID_TYPES = ["SBAQ", "VSAQ", "SAQ"];
    
    // Placeholder for your training data
    const TRAIN_DATA = `
    *** SBAQ EXAMPLES (Note: AI must generate distractors for these) ***
    1. (Biochem) Reaction: Pentose/TCA Step. Correct: Ligation reaction (D). Explanation: This reaction involves the joining of two molecules using ATP, characteristic of ligases.
    2. (CellBio) Cell cycle Go exit. Correct: Binding of EGF (B). Explanation: Epidermal Growth Factor (EGF) is a mitogen that signals cells to re-enter the cell cycle.
    3. (Maths) Beer-Lambert. 19.5 abs, 136390 coeff. Correct: 143 uM (D). Explanation: A = ecl. c = A/el = 19.5 / (136390 * 1) = 0.000143 M = 143 uM.
    4. (Clinical) 78F, pins/needles, MCV 112. Correct: B12 deficiency (A). Explanation: Macrocytic anaemia (high MCV) with neurological symptoms indicates B12 deficiency.
    5. (Biochem) Beta oxidation Palmitate. Correct: Acetyl CoA, NADH, FADH2 (A). Explanation: Beta oxidation produces these three products directly.
    6. (Pathology) Excessive matrix deposition. Correct: Pulmonary fibrosis (D). Explanation: Fibrosis is characterized by excess collagen/matrix deposition.
    7. (Biochem) Glucogenic amino acids. Correct: Used in gluconeogenesis (A). Explanation: Their carbon skeletons can be converted into glucose.
    8. (Haem) AML blood finding. Correct: Blast cells (A). Explanation: Acute Myeloid Leukaemia is characterized by the accumulation of immature blast cells.
    9. (Immuno) Immature in periphery, present to T cells. Correct: Dendritic cells (B). Explanation: DCs capture antigen in tissues and migrate to lymph nodes to present to T cells.
    10. (Pharm) Salbutamol mechanism. Correct: Activates intracellular G protein (C). Explanation: Salbutamol binds B2 receptors, which are GPCRs activating Gs proteins.
    11. (Stats) Plot type. Correct: Violin plot (E). Explanation: The plot shows probability density of the data at different values, characteristic of a violin plot.
    12. (Diagnostics) PCR advantage. Correct: Direct from specimen (D). Explanation: PCR is sensitive enough to detect DNA directly without culturing the organism.
    13. (Genetics) Oncogene tree trunk. Correct: Proto-oncogene C (C). Explanation: The "trunk" mutation is present in all subclones (1-5), which is Proto-oncogene C.
    14. (Pathology) Metaplasia definition. Correct: Reversible change of cell type (B). Explanation: Metaplasia is the reversible replacement of one adult cell type by another.
    15. (Pathology) Chronic inflammation cell. Correct: Macrophage (D). Explanation: Macrophages and lymphocytes are the hallmark cells of chronic inflammation.

    *** VSAQ EXAMPLES (Max 4 words) ***
    16. (Histology) Pancreas duct epithelium. Ans: Columnar epithelium. Explanation: The larger excretory ducts of the pancreas are lined by simple columnar epithelium.
    17. (Haem) MCH Calculation (Hb 153, RBC 5.1). Ans: 30.0 pg. Explanation: MCH = Hb/RBC = 153/5.1 = 30 pg.
    18. (Biochem) Albumin ID on plot. Ans: Protein 2. Explanation: Albumin is the most abundant plasma protein, and Protein 2 has the highest abundance in Panel A.
    19. (Micro) Fungal infections. Ans: Mycoses. Explanation: "Mycoses" is the general term for diseases caused by fungi.
    20. (Immuno) Lymphocyte migration vessel. Ans: High endothelial venule. Explanation: HEVs are specialized post-capillary venules allowing lymphocyte entry into lymph nodes.
    21. (Metabolism) Patient X mitochondria. Ans: Uncoupled from ATP production. Explanation: Oxygen consumption continues despite Oligomycin (ATP synthase inhibitor), meaning electron transport is uncoupled from ATP synthesis.
    22. (CellBio) Cdc25 role. Ans: Phosphatase. Explanation: Cdc25 removes the inhibitory phosphate from Cdk1, activating the complex.
    23. (Immuno) Thymus selection. Ans: T lymphocytes. Explanation: T cells mature and undergo positive/negative selection in the thymus.
    24. (Haem) Blood film arrow. Ans: Monocytes. Explanation: The kidney-bean shaped nucleus and grey-blue cytoplasm are characteristic of monocytes.
    25. (Pharm) Quinolone mechanism. Ans: Inhibits bacterial DNA replication. Explanation: Quinolones inhibit DNA gyrase/topoisomerase IV, preventing DNA replication.
    26. (Genetics) Inheritance pattern (Receptor activation). Ans: Autosomal dominant. Explanation: Gain-of-function mutations (constitutive activation) usually result in a dominant inheritance pattern.
    27. (Virology) CCR5 HIV stage. Ans: Cell entry. Explanation: CCR5 is a co-receptor required for HIV to fuse with and enter the host cell.
    28. (Immuno) ABO logic (Anti-B agg, Anti-A no agg). Ans: Group B. Explanation: Agglutination with Anti-B means B antigens are present. No agglutination with Anti-A means A antigens are absent.
    29. (Maths) Osmolarity Calc (PBS solution). Ans: 313.0 mOsm/L. Explanation: 137*2 (NaCl) + 2.7*2 (KCl) + 10*3 (Na2HPO4) + 1.8*2 (KH2PO4) = 274 + 5.4 + 30 + 3.6 = 313 mOsm/L.
    30. (Biochem) Lineweaver-Burk Vmax. Ans: 50 umol/mL/minute. Explanation: Y-intercept is 1/Vmax. Intercept is 0.02. Vmax = 1/0.02 = 50.

    *** SAQ EXAMPLES (Short Answer Questions - 10 Marks Total) ***
    
    [SAQ Example 1: Statins]
    Intro: Statins such as lovastatin act by competitively binding to the catalytic domain of 3-hydroxy-3-methylglutaryl coenzyme A reductase (HMG-CoA reductase, HMGCR).
    Part 1 (2 marks): Why are statins useful medications for the treatment of hypercholesterolaemia and why is HMGCR an ideal target for such drugs?
    Model Answer: 1. HMG-CoA reductase catalyses the rate-limiting step of cholesterol biosynthesis. 2. Reduction in HMG-CoA activity therefore results in reduced cholesterol levels.
    
    Part 2 (2 marks): The accompanying graphs present data sets showing that experimental treatment of mice with lovastatin results in an increase in HMGCR in liver at the protein and mRNA levels. Suggest how the liver responds to treatment with lovastatin. How do you think this might alter the usefulness of statins following prolonged treatment?
    Model Answer: 1. The liver appears to compensate for reduced HMGCR function by increasing production of HMGCR at RNA and protein levels. 2. The usefulness of statins in treating therefore be reduced if treatment is prolonged.
    
    Part 3 (3 marks): Compound 81 is a novel, small molecule discovered to enhance the rate of degradation of HMGCR. Describe the effects of compound 81 and lovastatin on the formation of atherosclerotic lesions based on the data.
    Model Answer: 1. Compound 81 alone significantly reduces lesion area. 2. The effectiveness of compound 81 in reducing lesion area is equivalent to lovastatin. 3. The combination of compound 81 and lovastatin is significantly more effective than either single treatment.
    
    Part 4 (3 marks): The cholesterol metabolite 7-dehydrocholesterol is an intermediate in the synthesis of the active vitamin D metabolite known as calcitriol. Suggest why the increased use of sunscreen might be related to low levels of calcitriol in apparently healthy young adults.
    Model Answer: 1. Calcitriol acts as a steroid hormone to induce key genes involved in bone metabolism. 2. A key stage in the metabolism of 7-dehydrocholesterol to calcitriol is the action of UV light. 3. Sunscreens block UV light and hence the production of calcitriol.

    [SAQ Example 2: Chemokines]
    Intro: A mature T-cell responds to the chemokines CCL22 and CCL17 by leaving the circulation and entering inflamed skin where it may encounter antigen.
    Part 1 (3 marks): Name the class of molecules denoted by the letters A and B and the cellular process denoted by the letter C.
    Model Answer: 1. A is Selectin. 2. B is Integrin. 3. Process is transcytosis a.k.a. diapedesis or transmigration.
    
    Part 2 (1 mark): A synthetic CCL22 protein was produced in bacteria and quantified using a spectrophotometer at 280 nm. Give one feature of the CCL22 protein that may contribute to its absorbance at this wavelength.
    Model Answer: 1. Tyrosine residues OR Tryptophan residues OR Phenylalanine residues OR Disulphide-bonds.
    
    Part 3 (3 marks): Absorption was found to be 24.5 units in a 1 cm cuvette. State the Beer-Lambert law and use it to calculate the concentration of the spike protein in the buffer in micromoles per litre. Coeff is 136,390 M-1 cm-1.
    Model Answer: 1. A = e * c * l (Beer-Lambert Law). 2. C = 24.5 / 136390 = 0.000180 M. 3. C = 180 uM (units required).
    
    Part 4 (3 marks): Describe three mechanisms that bacteria use to evade the effects of antibodies.
    Model Answer: 1. Capsule to hide antigens. 2. Surface proteins (eg. Spa) that bind the Fc region and disrupt function. 3. Secreted proteins (eg. SSL10) that bind the Fc region and prevent detection OR Express bacterial proteases that cleave immunoglobulin.
    `;

    const HIST_KEY = 'imp_hist_v5';
    const ERR_KEY = 'imp_err_v5';

    // FILTER STATE
    let activeTypeFilters = [...VALID_TYPES];
    let activeTagFilters = [...VALID_TAGS];
    
    // VIEW & EXAM STATE
    let isSingleView = localStorage.getItem('pom_view_mode') === 'single';
    let currentQuestionIndex = 0;
    let isSubmitted = false; 

    function getHistory() { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); }
    function getErrors() { return JSON.parse(localStorage.getItem(ERR_KEY) || '[]'); }
    
    function saveHistoryEntry(q, isCorrect) {
        const hist = getHistory();
        hist.push({ 
            timestamp: new Date().toISOString(), 
            question: q.question, 
            isCorrect: isCorrect, 
            type: q.type,
            tag: q.tag || "Uncategorized"
        });
        localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        updateStats();
    }

    function saveError(q, userAns) {
        let errs = getErrors();
        let existing = errs.find(e => e.question === q.question);
        if(existing) {
            existing.userLastAnswer = userAns;
            existing.timestamp = new Date().toISOString();
            existing.repCount = (existing.repCount || 1) + 1;
        } else {
            errs.push({ timestamp: new Date().toISOString(), userLastAnswer: userAns, ...q, repCount: 1 });
        }
        localStorage.setItem(ERR_KEY, JSON.stringify(errs));
        updateStats();
    }
    
    function updateErrorTag(questionText, newTag) {
        let errs = getErrors();
        let e = errs.find(err => err.question === questionText);
        if(e) { e.tag = newTag; localStorage.setItem(ERR_KEY, JSON.stringify(errs)); }
    }

    function removeError(questionText) {
        let errs = getErrors();
        errs = errs.filter(e => e.question !== questionText);
        localStorage.setItem(ERR_KEY, JSON.stringify(errs));
        updateStats();
    }

    function updateStats() {
        const hist = getHistory();
        const errs = getErrors();
        const todayStr = new Date().toISOString().slice(0,10);
        const todayEntries = hist.filter(h => h.timestamp.startsWith(todayStr));
        const todayTotal = todayEntries.length;
        const todayCorrect = todayEntries.filter(h => h.isCorrect).length;
        const acc = todayTotal > 0 ? Math.round((todayCorrect / todayTotal) * 100) : 0;
        document.getElementById('stat-today-count').innerText = todayTotal;
        document.getElementById('stat-accuracy').innerText = acc + "%";
        document.getElementById('stat-error-bank').innerText = errs.length;
    }
    updateStats();
    
    function updateFileList() {
        const input = document.getElementById('file-input');
        const display = document.getElementById('file-list-display');
        display.innerHTML = "";
        for(let f of input.files) display.innerHTML += `<span class="file-chip">üìÑ ${f.name}</span>`;
    }
    
    function blobToBase64(blob) {
        return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result.split(',')[1]);
            r.readAsDataURL(blob);
        });
    }

    async function processFiles() {
        const input = document.getElementById('file-input');
        let parts = [];
        for(let file of input.files) {
            const name = file.name.toLowerCase();
            if(name.endsWith('.pptx') || name.endsWith('.docx')) {
                const zip = await JSZip.loadAsync(file);
                let text = `\n--- CONTENT: ${file.name} ---\n`;
                let xmlFiles = Object.keys(zip.files).filter(n => n.match(/(document|slide\d+)\.xml/));
                xmlFiles.sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0));
                for(let x of xmlFiles) {
                    const content = await zip.files[x].async("string");
                    text += content.replace(/<[^>]+>/g, ' ') + "\n";
                }
                parts.push({ text: text });
                let imgs = Object.keys(zip.files).filter(n => n.match(/media\/.*\.(png|jpg|jpeg)$/i));
                for(let img of imgs) {
                    const blob = await zip.files[img].async("blob");
                    const b64 = await blobToBase64(blob);
                    parts.push({ inline_data: { mime_type: blob.type || "image/jpeg", data: b64 } });
                }
            } else {
                const b64 = await blobToBase64(file);
                parts.push({ inline_data: { mime_type: file.type || "application/pdf", data: b64 } });
            }
        }
        return parts;
    }

    let currentExamData = [];
    let currentMaxScore = 0;
    let currentUserScore = 0;
    let timerInterval;

    async function generateExam() {
        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');
        document.getElementById('gen-btn').disabled = true;

        try {
            const sbaqN = parseInt(document.getElementById('sbaq-count').value);
            const vsaqN = parseInt(document.getElementById('vsaq-count').value);
            const saqN = parseInt(document.getElementById('saq-count').value);
            const mixErrors = document.getElementById('mix-errors-toggle').checked;
            const hideTags = document.getElementById('hide-tags-toggle').checked;
            const appMode = document.getElementById('application-mode-toggle').checked;
            const useStyle = true; 

            // RESET EXAM STATE
            isSubmitted = false;
            
            // ANALYTICS TRACKING
            if (typeof gtag === 'function') {
                gtag('event', 'generate_session', { 'event_category': 'Exam', 'value': sbaqN + vsaqN + saqN });
                if (sbaqN > 0) gtag('event', 'gen_sbaq', { 'event_category': 'Exam', 'value': sbaqN });
                if (vsaqN > 0) gtag('event', 'gen_vsaq', { 'event_category': 'Exam', 'value': vsaqN });
                if (saqN > 0) gtag('event', 'gen_saq', { 'event_category': 'Exam', 'value': saqN });
            }

            const key = document.getElementById('api-key').value;
            if (key) { localStorage.setItem('pom_api_key', key); }

            let reviewQuestions = [];
            if (mixErrors) {
                const errors = getErrors();
                if(errors.length > 0) {
                    const totalReq = sbaqN + vsaqN + saqN;
                    const reviewCount = Math.min(errors.length, Math.ceil(totalReq * 0.3)); 
                    errors.sort((a,b) => (b.repCount || 1) - (a.repCount || 1));
                    reviewQuestions = errors.slice(0, reviewCount).map(q => ({...q, isReview: true}));
                }
            }

            let newQuestions = [];
            if (sbaqN + vsaqN + saqN > 0) {
                const fileParts = await processFiles();
                const notes = document.getElementById('notes-input').value;
                let styleInstruction = "";
                if(useStyle) { styleInstruction = `STYLE GUIDE (Mimic this EXACTLY):\n${TRAIN_DATA}`; }

                let modeInstruction = "FOCUS: 100% Direct Recall questions (Definitions, Facts).";
                if(appMode) {
                    modeInstruction = "FOCUS: 50% Direct Recall and 50% Application/Vignette style questions. For Application, create a clinical or experimental scenario where the answer can be DEDUCED from the text (do not hallucinate outside facts). If the source text is too dry, default back to Recall.";
                }

                let saqInstruction = "";
                let saqJsonTemplate = "";
                if (saqN === 0) {
                    saqInstruction = "CRITICAL: DO NOT GENERATE ANY SAQ (Short Answer Questions). Only generate SBAQ and VSAQ.";
                    saqJsonTemplate = "";
                } else {
                    saqInstruction = `3. SAQ: 'intro', 'parts' (question, marks, model_answer array). Total 10 marks.`;
                    saqJsonTemplate = `
                      {
                        "type":"SAQ", 
                        "tag":"...",
                        "intro":"...", 
                        "parts": [
                          {"id":1, "question":"...", "marks":2, "model_answer":["Point 1 (1)", "Point 2 (1)"]},
                          {"id":2, "question":"...", "marks":3, "model_answer":["..."]}
                        ]
                      }`;
                }

                const prompt = `
                    You are an Imperial College London medical examiner. Create exam questions based on content.
                    
                    CRITICAL - STRICT SCOPE CONTAINMENT: 
                    - You must ONLY generate questions based on the specific text and images provided in the 'user' parts of this prompt.
                    - DO NOT use your outside medical knowledge to create questions about topics not present in the files.
                    - If the files do not mention a specific disease, protein, or pathway, DO NOT ask about it.

                    REQUIRED: ${sbaqN} SBAQs, ${vsaqN} VSAQs, and ${saqN} SAQs.
                    IMPORTANT TAGGING: Assign strictly one of these tags to "tag" field: 
                    - "Molecular Biology of the Cell"
                    - "Haematology"
                    - "Immunology & Infection"
                    - "Genetics"
                    
                    CRITICAL RULES FOR QUALITY CONTROL:
                    1. DISTRACTORS: Must be of the SAME CATEGORY and DATA TYPE as the correct answer. (e.g. if the answer is a time '20 mins', distractors must be other times '10 mins', '1 hour').
                    2. META-LANGUAGE BAN: NEVER use phrases like "According to the text", "The notes mention". Write as if you are a standard external exam board.
                    3. DIFFICULTY: Options must be homogeneous in tone. Avoid "positive" vs "negative" outliers.
                    4. EXPLANATION FORMAT: Use HTML tags (<br>, <b>) for formatting. Structure: "<b>Correct:</b> [Reason]. <br><br><b>Why others are wrong:</b>..."
                    
                    ${modeInstruction}

                    TYPES:
                    1. SBAQ: Must include 5 options (A-E). "correctAnswer" MUST be the EXACT option text string.
                    2. VSAQ: 1-4 words max answer.
                    ${saqInstruction}

                    *** STRICT SAQ MARKING RULE ***
                    You MUST enforce a 1-to-1 ratio between 'marks' and 'model_answer' items:
                    - If "marks": 2, the "model_answer" array MUST contain exactly 2 separate strings.
                    - If "marks": 4, the "model_answer" array MUST contain exactly 4 separate strings.
                    - DO NOT combine multiple points into one string. Split them up so the user gets one checkbox per mark.
                    - WRONG: "marks": 2, "model_answer": ["Cell membrane and Nucleus"] (This is only 1 item).
                    - CORRECT: "marks": 2, "model_answer": ["Cell membrane", "Nucleus"] (This is 2 items).

                    ${styleInstruction}
                    JSON FORMAT ONLY:
                    [
                    {"type":"SBAQ", "tag":"...", "question":"...", "options":["A...","B...","C...","D...","E..."], "correctAnswer":"...", "explanation":"..."},
                    {"type":"VSAQ", "tag":"...", "question":"...", "acceptedAnswers":["..."], "explanation":"..."}${saqN > 0 ? ',' : ''}
                    ${saqJsonTemplate}
                ]`;
                
                const parts = [{text: prompt}];
                if(notes) parts.push({text: "NOTES:\n"+notes});
                parts.push(...fileParts);
                const model = document.getElementById('model-select').value;
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });
                const data = await resp.json();
                if(data.error) throw new Error(data.error.message);
                let txt = data.candidates[0].content.parts[0].text;
                txt = txt.replace(/```json/g, '').replace(/```/g, '').trim();
                const first = txt.indexOf('['); const last = txt.lastIndexOf(']');
                if(first > -1) txt = txt.substring(first, last+1);
                newQuestions = JSON.parse(txt);
            }

            currentExamData = [...reviewQuestions, ...newQuestions];
            currentExamData.sort((a,b) => (a.type === 'SAQ' ? 1 : -1));
            renderExam(currentExamData, 'questions-container', false, hideTags);
            startTimer();

        } catch(e) {
            showCustomAlert("Generation Error", e.message);
        } finally {
            loading.classList.add('hidden');
            document.getElementById('gen-btn').disabled = false;
        }
    }

    function startTimer() {
        let sec = 0; clearInterval(timerInterval);
        const disp = document.getElementById('timer-display');
        timerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60).toString().padStart(2,'0');
            const s = (sec % 60).toString().padStart(2,'0');
            disp.innerText = `${m}:${s}`;
        }, 1000);
    }

    function saveActiveState() {
        currentExamData.forEach((q, i) => {
            if (q.type === 'SBAQ') {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if (selected) {
                    q.activeUserAnswer = selected.value.trim();
                }
            } else if (q.type === 'VSAQ') {
                const el = document.getElementById(`input-${i}`);
                if (el) q.activeUserAnswer = el.value;
            } else if (q.type === 'SAQ') {
                q.activeUserAnswer = [];
                const areas = document.querySelectorAll(`#card-${i} textarea`);
                areas.forEach(a => q.activeUserAnswer.push(a.value));
            }
        });
    }

    // --- VIEW MODE & EXCLUSION LOGIC (NEW v6.6) ---

    function toggleViewMode() {
        saveActiveState();
        isSingleView = !isSingleView;
        localStorage.setItem('pom_view_mode', isSingleView ? 'single' : 'list');
        
        // Check if we are in review mode or exam mode
        const isReview = !document.getElementById('review-screen').classList.contains('hidden');
        const containerId = isReview ? 'review-container' : 'questions-container';
        
        // Pass 'isReview' explicitly, and check hide-tags only if NOT in review
        const hideTags = isReview ? false : document.getElementById('hide-tags-toggle').checked;
        
        renderExam(currentExamData, containerId, isReview, hideTags);
        
        // IMPORTANT: If we are in Exam Mode and already submitted, we must
        // re-run the submission logic to show feedback/colors again.
        if (!isReview && isSubmitted) {
            submitQuiz(true); // true = re-render mode
        }
    }

    function prevQuestion() {
        if(currentQuestionIndex > 0) {
            currentQuestionIndex--;
            updateSingleView();
        }
    }

    function nextQuestion() {
        if(currentQuestionIndex < currentExamData.length - 1) {
            currentQuestionIndex++;
            updateSingleView();
        }
    }

    function updateSingleView() {
        // Hide all cards, show current
        document.querySelectorAll('.q-card').forEach((card, idx) => {
            card.classList.toggle('hidden', idx !== currentQuestionIndex);
        });
        
        // Update Sidebar Dots active state manually since intersection observer doesn't work well here
        document.querySelectorAll('.nav-dot').forEach((dot, idx) => {
            dot.classList.toggle('active-dot', idx === currentQuestionIndex);
        });
    }

    function toggleExclusion(qIndex, optIndex, event) {
        event.stopPropagation(); // Prevent radio selection
        const optionDiv = document.getElementById(`opt-${qIndex}-${optIndex}`);
        optionDiv.classList.toggle('excluded');
    }

    function promptChangeTag(index) {
        saveActiveState(); 

        const currentTag = currentExamData[index].tag || "Uncategorized";
        let newTagIndex = VALID_TAGS.indexOf(currentTag);
        
        if (newTagIndex === -1) newTagIndex = 0;
        else newTagIndex = (newTagIndex + 1) % VALID_TAGS.length;
        
        const newTag = VALID_TAGS[newTagIndex];
        
        currentExamData[index].tag = newTag;
        updateErrorTag(currentExamData[index].question, newTag);
        
        const isReview = !document.getElementById('review-screen').classList.contains('hidden');
        const hideTags = document.getElementById('hide-tags-toggle').checked;
        
        if(isReview) {
            applyFilters(); 
        } else {
            renderExam(currentExamData, 'questions-container', false, hideTags);
            if(isSubmitted) submitQuiz(true);
        }
    }

    function renderExam(data, containerId, isReviewMode = false, hideTags = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        currentMaxScore = 0; 
        
        // FORCE LIST VIEW IF IN REVIEW MODE
        const effectiveSingleView = isReviewMode ? false : isSingleView;

        // Update Header Button Text
        const viewBtn = document.getElementById('view-toggle-btn');
        if(viewBtn) viewBtn.innerText = 'Toggle View';
        
        // MANAGE SUBMIT BUTTONS
        const fab = document.getElementById('floating-submit');
        const mainSubmit = document.getElementById('submit-btn');
        
        if (!isReviewMode && !isSubmitted) {
            // Exam Mode, Not Submitted: Show one based on view
            if (fab) fab.style.display = effectiveSingleView ? 'flex' : 'none';
            if (mainSubmit) mainSubmit.style.display = effectiveSingleView ? 'none' : 'block';
        } else {
            // Review Mode OR Submitted: Hide both
            if (fab) fab.style.display = 'none';
            if (mainSubmit) mainSubmit.style.display = 'none';
        }

        const nav = document.getElementById('nav-sidebar');
        nav.innerHTML = '';
        
        if(effectiveSingleView) nav.classList.add('bottom-mode');
        else nav.classList.remove('bottom-mode');

        if(!isReviewMode) {
            nav.style.display = 'flex';
            if(effectiveSingleView) nav.innerHTML += `<button class="nav-arrow" onclick="prevQuestion()">‚óÄ</button>`;

            // CRITICAL FIX: Loop variable is now 'q' instead of '_' to prevent crash
            data.forEach((q, i) => {
                let onClick = effectiveSingleView 
                    ? `currentQuestionIndex = ${i}; updateSingleView();` 
                    : `document.getElementById('card-${i}').scrollIntoView({behavior:'smooth'})`;
                
                // DETERMINE DOT CLASS (The Fix)
                let dotClass = "nav-dot";
                
                // 1. If Submitted/Marked (Red/Green)
                if (isSubmitted) {
                    // Re-calculate correctness roughly to color the dot
                    let isCorrect = false;
                    if(q.type === 'SAQ') {
                         if(q.activeUserAnswer && q.activeUserAnswer.length > 0) dotClass += " answered";
                    } else if (q.activeUserAnswer) {
                        // Simple re-check for SBAQ/VSAQ color
                        let ans = q.activeUserAnswer.toLowerCase().trim();
                        let corr = (q.correctAnswer || q.acceptedAnswers[0]).toLowerCase().trim();
                        // Strip A. B. etc for comparison
                        ans = ans.replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                        corr = corr.replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                        
                        if(q.type === 'VSAQ') {
                             if(q.acceptedAnswers.some(a => a.toLowerCase().includes(q.activeUserAnswer.toLowerCase()))) dotClass += " correct";
                             else dotClass += " wrong";
                        } else {
                            if(ans === corr || q.activeUserAnswer.toLowerCase() === (q.correctAnswer||"").toLowerCase()) dotClass += " correct";
                            else dotClass += " wrong";
                        }
                    }
                } 
                // 2. If just Answered (Blue)
                else if (q.activeUserAnswer && (q.activeUserAnswer.length > 0 || (Array.isArray(q.activeUserAnswer) && q.activeUserAnswer.some(x=>x)))) {
                    dotClass += " answered";
                }

                nav.innerHTML += `<div class="${dotClass}" id="dot-${i}" onclick="${onClick}"><span class="nav-tooltip">Q${i+1}</span></div>`;
            });

            if(effectiveSingleView) nav.innerHTML += `<button class="nav-arrow" onclick="nextQuestion()">‚ñ∂</button>`;

        } else {
            nav.style.display = 'none';
        }

        // SCROLL SPY LOGIC (Only active in List View)
        let observer;
        if (!effectiveSingleView) {
            const observerOptions = { root: null, rootMargin: '0px', threshold: 0.6 };
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.nav-dot').forEach(d => d.classList.remove('active-dot'));
                        const id = entry.target.id.split('-')[1];
                        const dot = document.getElementById(`dot-${id}`);
                        if(dot) dot.classList.add('active-dot');
                    }
                });
            }, observerOptions);
        }

        data.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'q-card';
            div.id = `card-${i}`;
            
            if(effectiveSingleView && i !== currentQuestionIndex) div.classList.add('hidden');
            if(!effectiveSingleView && observer) observer.observe(div);
            
            let tagDisplay = q.tag || "Uncategorized";
            let tagClass = "badge";
            if(hideTags && !isReviewMode) tagClass += " hidden-tag";
            
            let badges = `<span class="badge" style="background:#e9ecef;color:#666">${q.type}</span>`;
            badges += `<span class="${tagClass}" style="background:var(--brand-secondary); color:white;" onclick="promptChangeTag(${i})" title="Click to change topic">${tagDisplay} ‚úé</span>`;
            
            if(q.isReview) badges += `<span class="badge" style="background:var(--flag-bg); color:var(--flag-text);">SRS Review</span>`;

            let contentHTML = '';
            // Only allow marking Nav answered if NOT in review AND NOT submitted
            const inputAction = (!isReviewMode && !isSubmitted) ? `onchange="markNavAnswered(${i})"` : '';

            const getVal = (def = '') => {
                if (isReviewMode && q.userLastAnswer) return q.userLastAnswer;
                if (!isReviewMode && q.activeUserAnswer) return q.activeUserAnswer;
                return def;
            };

            const isDisabled = isReviewMode || isSubmitted ? 'disabled' : '';

            if(q.type === 'SAQ') {
                currentMaxScore += 10;
                contentHTML += `<div class="saq-intro">${q.intro || q.question}</div>`;
                const savedAns = getVal([]); 
                
                q.parts.forEach((part, pIndex) => {
                    const val = savedAns[pIndex] || '';
                    contentHTML += `
                    <div class="saq-part">
                        <strong>Part ${pIndex+1} (${part.marks} marks)</strong><br>
                        ${part.question}<br>
                        <textarea style="margin-top:10px; height:60px;" placeholder="Type answer here..." oninput="autoResize(this); markNavAnswered(${i})" ${isDisabled}>${val}</textarea>
                        <div id="saq-mark-${i}-${pIndex}" class="marking-scheme" style="${(isReviewMode || isSubmitted) ? 'display:block' : ''}">
                            <strong>Model Answer (Tick marks earned):</strong><br>
                            ${part.model_answer.map((point) => `
                                <label class="mark-point"><input type="checkbox" onchange="updateSAQScore(${i})"> ${point}</label>
                            `).join('')}
                        </div>
                    </div>`;
                });
            } else if(q.type === 'SBAQ') {
                currentMaxScore += 1;
                let opts = q.options || [];
                contentHTML = `<div style="display:grid; gap:10px;">`;
                
                const userSel = getVal(); 

                opts.forEach((opt, optIndex) => {
                    const val = typeof opt === 'string' ? opt : JSON.stringify(opt);
                    const clean = val.replace(/^[A-E]\.\s*/, '').trim();
                    
                    let isChecked = false;
                    if(userSel) {
                         const cleanUser = userSel.replace(/^[A-E]\.\s*/, '').trim().toLowerCase();
                         if(clean.toLowerCase() === cleanUser) isChecked = true;
                    }

                    contentHTML += `<div class="option-item" id="opt-${i}-${optIndex}" style="${isChecked ? 'border-color:var(--brand-primary); background:rgba(0,33,71,0.05);' : ''}">
                            <label><input type="radio" name="q${i}" value="${clean.replace(/"/g, '&quot;')}" ${isChecked?'checked':''} ${isDisabled} ${inputAction}> ${clean}</label>
                            <button class="exclude-btn" onclick="toggleExclusion(${i}, ${optIndex}, event)" title="Exclude Answer">‚úï</button>
                        </div>`;
                });
                contentHTML += `</div>`;
            } else {
                currentMaxScore += 1;
                const val = getVal();
                contentHTML = `<input type="text" id="input-${i}" placeholder="Max 4 words..." value="${val}" onkeyup="checkWordCount(${i}); markNavAnswered(${i})" ${isDisabled}>
                    <span id="count-${i}" class="word-count">0/4 words</span>`;
            }

            let feedbackContent = '';
            if ((isReviewMode || isSubmitted) && q.type !== 'SAQ') {
                feedbackContent = `<strong>Correct:</strong> ${q.correctAnswer || q.acceptedAnswers}<br><br><strong>Analysis:</strong><br>${q.explanation}`;
            }

            div.innerHTML = `
                <div class="q-header"><div>${badges}</div><button class="flag-btn" onclick="toggleFlag(${i}, this)">üö©</button></div>
                <h3 style="margin-top:0">${i+1}. ${q.type === 'SAQ' ? 'Short Answer Question' : q.question}</h3>
                ${contentHTML}
                <div id="feedback-${i}" class="feedback-box" style="${(isReviewMode || isSubmitted) && q.type !== 'SAQ' ? 'display:block; background:rgba(0,0,0,0.03); color:var(--text-main); border:1px solid var(--border-subtle);' : ''}">${feedbackContent}</div>
            `;
            container.appendChild(div);
        });

        if(effectiveSingleView) updateSingleView();

        if(!isReviewMode) {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('review-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('sticky-score').style.display = 'flex';
            document.getElementById('header-score-display').innerText = `0/${currentMaxScore}`;
            
            // Auto scroll to top only if this is a fresh start and not a re-render
            if(!currentExamData.some(q => q.activeUserAnswer) && !effectiveSingleView && !isSubmitted) window.scrollTo(0,0);
        }
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function checkWordCount(i) {
        const inp = document.getElementById(`input-${i}`);
        const cnt = document.getElementById(`count-${i}`);
        const w = inp.value.trim().split(/\s+/).filter(x=>x).length;
        cnt.innerText = `${w}/4 words`;
        if(w>4) { cnt.classList.add('error'); inp.style.borderColor='var(--error-text)'; }
        else { cnt.classList.remove('error'); inp.style.borderColor='var(--border-subtle)'; }
    }
    function toggleFlag(i, btn) {
        btn.classList.toggle('active');
        const card = document.getElementById(`card-${i}`);
        card.classList.toggle('flagged');
        const dot = document.getElementById(`dot-${i}`);
        if(dot) { if(card.classList.contains('flagged')) dot.classList.add('flagged'); else dot.classList.remove('flagged'); }
    }
    function markNavAnswered(i) { const dot = document.getElementById(`dot-${i}`); if(dot) dot.classList.add('answered'); }

    function updateSAQScore(qIndex) {
        let total = currentUserScore;
        const checkboxes = document.querySelectorAll('.mark-point input[type="checkbox"]:checked');
        const saqScore = checkboxes.length;
        const finalScore = total + saqScore;
        const percent = Math.round((finalScore / currentMaxScore) * 100);
        document.getElementById('header-score-display').innerText = `${finalScore}/${currentMaxScore} (${percent}%)`;
        if (qIndex !== undefined) {
            const cardChecks = document.querySelectorAll(`#card-${qIndex} .mark-point input[type="checkbox"]`);
            const checked = document.querySelectorAll(`#card-${qIndex} .mark-point input[type="checkbox"]:checked`);
            const dot = document.getElementById(`dot-${qIndex}`);
            if(dot) {
                dot.classList.remove('answered', 'wrong', 'correct', 'partial');
                if(checked.length === 0) dot.classList.add('wrong');
                else if(checked.length === cardChecks.length) dot.classList.add('correct');
                else dot.classList.add('partial');
            }
        }
    }

    function submitQuiz(isReRender = false) {
        if (!isReRender) {
            clearInterval(timerInterval);
            isSubmitted = true;
        }

        let score = 0;
        
        currentExamData.forEach((q, i) => {
            const dot = document.getElementById(`dot-${i}`);
            
            if(q.type === 'SAQ') {
                const schemes = document.querySelectorAll(`#card-${i} .marking-scheme`);
                schemes.forEach(s => s.style.display = 'block');
                if(!isReRender) {
                    const inputs = document.querySelectorAll(`#card-${i} textarea`);
                    const answers = Array.from(inputs).map(inp => inp.value);
                    saveError(q, answers);
                }
                if(dot && !dot.classList.contains('correct') && !dot.classList.contains('partial')) { 
                    dot.classList.remove('answered'); dot.classList.add('wrong'); 
                }
                return; 
            }

            const feedback = document.getElementById(`feedback-${i}`);
            let isCorrect = false;
            let correctAns = q.correctAnswer || (q.acceptedAnswers ? q.acceptedAnswers[0] : "See explanation");
            let userAns = "";

            if(q.type === 'SBAQ') {
                const radios = document.querySelectorAll(`input[name="q${i}"]`);
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                
                if(selected) {
                    userAns = selected.value.trim();
                    const cleanSel = userAns.toLowerCase();
                    const cleanCorrect = correctAns.trim().toLowerCase();
                    const selText = cleanSel.replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');
                    const corText = cleanCorrect.replace(/^(option\s+)?[a-e][\.\)\s]\s*/, '');

                    if(selText === corText || cleanSel === cleanCorrect) {
                        isCorrect = true;
                    } 
                    else {
                        const letterMatch = cleanCorrect.match(/^(option\s+)?([a-e])([\.\)\s]|$)/);
                        if(letterMatch) {
                            const correctLetter = letterMatch[2]; 
                            const correctIndex = correctLetter.charCodeAt(0) - 97;
                            const selectedIndex = Array.from(radios).findIndex(r => r === selected);
                            if(correctIndex === selectedIndex && selectedIndex !== -1) isCorrect = true;
                        }
                    }
                }
            } 
            else {
                userAns = document.getElementById(`input-${i}`).value;
                const acc = q.acceptedAnswers || [correctAns];
                if(acc.some(a => a.toLowerCase().includes(userAns.toLowerCase()) && userAns.length>1)) isCorrect = true;
            }
            
            if(isCorrect) {
                score++;
                if(!isReRender) removeError(q.question); 
            } else {
                if(!isReRender) saveError(q, userAns || "No Answer");
            }
            
            if(!isReRender) saveHistoryEntry(q, isCorrect);
            
            if(dot) { 
                dot.classList.remove('answered'); 
                if(isCorrect) dot.classList.add('correct'); 
                else dot.classList.add('wrong'); 
            }
            
            feedback.style.display = 'block';
            feedback.className = isCorrect ? 'feedback-box correct' : 'feedback-box wrong';
            feedback.innerHTML = `<strong>${isCorrect?'Correct':'Incorrect'}</strong><br>Answer: ${correctAns}<br><br><strong>Analysis:</strong><br>${q.explanation}`;
            
            if(!isCorrect && q.type === 'VSAQ') {
                feedback.innerHTML += `<button class="btn btn-secondary" style="margin-top:10px; width:100%" onclick="markCorrect(${i})">Mark as Correct</button>`;
            }
        });

        currentUserScore = score; 
        updateSAQScore(); 
        
        // Hide all submit buttons if submitted
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('floating-submit').style.display = 'none';
        
        if(!isReRender && !currentExamData.some(q => q.type === 'SAQ')) {
            const pct = Math.round((score/currentMaxScore)*100);
            showResultModal(pct, score, currentMaxScore);
            if(pct > 70) confetti();
        } else if (!isReRender) {
            showCustomAlert("Self Marking Required", "Please self-mark the SAQ sections by ticking the boxes for points achieved.");
        }
    }

    function markCorrect(i) {
        currentUserScore++; const q = currentExamData[i];
        removeError(q.question);
        document.getElementById(`feedback-${i}`).className = 'feedback-box correct';
        const dot = document.getElementById(`dot-${i}`); if(dot) { dot.classList.remove('wrong'); dot.classList.add('partial'); }
        updateSAQScore();
    }
    
    // --- CUSTOM MODAL SYSTEM ---

    function showCustomAlert(title, message) {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0;">${title}</h2>
            <p style="color:var(--text-main); margin-bottom:25px;">${message}</p>
            <button class="btn btn-primary" onclick="closeGenericModal()">OK</button>
        `;
        modal.style.display = 'flex';
    }

    function showCustomConfirm(title, message, onYes) {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0;">${title}</h2>
            <p style="color:var(--text-main); margin-bottom:25px;">${message}</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="closeGenericModal()" style="flex:1">Cancel</button>
                <button class="btn btn-primary" id="confirm-yes-btn" style="flex:1">Confirm</button>
            </div>
        `;
        document.getElementById('confirm-yes-btn').onclick = function() {
            onYes();
            closeGenericModal();
        };
        modal.style.display = 'flex';
    }

    function showResultModal(pct, score, max) {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <div class="score-circle">${pct}%</div>
            <h2 style="color:var(--brand-primary);">Session Complete</h2>
            <p style="color:var(--text-sub); margin-bottom:25px;">Score: ${score}/${max}</p>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeGenericModal()" class="btn btn-secondary" style="flex:1">Review Answers</button>
                <button onclick="location.reload()" class="btn btn-primary" style="flex:1">Next Exam</button>
            </div>
        `;
        modal.style.display = 'flex';
    }
    
    function openInstructions() {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0; border-bottom:1px solid #ddd; padding-bottom:10px;">PoM Exam Generator Guide</h2>
            
            <div class="instruction-section">
                <h3>1. Initial Setup</h3>
                <p>This app requires a <strong>Gemini API Key</strong> to function. It's free and easy to get:</p>
                <ul>
                    <li><a href="https://support.google.com/accounts?p=verify_age&sjid=2239933336911860722-EU" target="_blank" class="highlight">Verify your age to Google</a> if you haven't already.</li>
                    <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="highlight">Google AI Studio</a>.</li>
                    <li>Click the blue <strong>"Get API key"</strong> button.</li>
                    <li>Click <strong>"Create API key"</strong>.</li>
                    <li>Copy the long code (starts with "AIza...") and paste it into the "API Key" box on the dashboard.</li>
                </ul>
                <p><em>(Your key will be saved automatically for next time!)</em></p>
            </div>
            
            <div class="instruction-section">
                <h3>2. Uploading Content</h3>
                <p><strong>Supported Files:</strong> PDF, PPTX, DOCX, TXT, and Images.</p>
                <p><strong>How it works:</strong> Drag and drop your lecture slides. The app extracts text and images to generate questions based strictly on that content.</p>
            </div>

            <div class="instruction-section">
                <h3>3. Exam Configuration</h3>
                <ul>
                    <li><strong>Questions:</strong> Choose the number of SBAQ, VSAQ, and SAQ.</li>
                    <li><strong>SRS Logic:</strong> Toggle this to include questions you previously got wrong in the new exam session.</li>
                    <li><strong>Application Mode:</strong> Toggle ON for a mix of clinical scenarios and direct recall questions.</li>
                    <li><strong>Hide Tags:</strong> Use this for "Mock Exam" conditions where you don't want topic hints.</li>
                </ul>
            </div>

            <div class="instruction-section">
                <h3>4. Taking the Exam</h3>
                <p>Use the sidebar (or bottom bar in Single View) to navigate questions. Flag questions for review using the üö© icon.</p>
                <ul>
                    <li><strong>Toggle View:</strong> Switch between standard scrolling list or "Single View".</li>
                    <li><strong>‚úï Exclusions:</strong> Visually cross out wrong answers in SBAQs.</li>
                </ul>
                <p><strong>SAQs:</strong> These are self-marked. After submitting, tick the checkboxes for the points you achieved based on the model answer.</p>
            </div>

            <div class="instruction-section">
                <h3>5. Mistake Bank & Exports</h3>
                <p>Any question you get wrong is saved to the "Review Mistakes" library.</p>
                <ul>
                   <li><strong>HTML Export:</strong> Download a formatted "Mistake Bank" file.</li>
                   <li><strong>Tagging:</strong> Click the colored topic badge on any question to manually change its category.</li>
                </ul>
            </div>

            <div class="disclaimer-box">
                <strong>‚ö†Ô∏è Disclaimer:</strong><br>
                This tool uses Generative AI (Gemini Flash). While strict controls are in place to prevent hallucinations, mistakes can still occur. Always verify answers against your official lecture notes.
            </div>

            <button class="btn btn-primary" onclick="closeGenericModal()" style="margin-top:20px; width:100%;">Close Guide</button>
        `;
        modal.style.display = 'flex';
    }

    function openChangelog() {
        const modal = document.getElementById('generic-modal');
        const content = document.getElementById('modal-inner-content');
        content.innerHTML = `
            <h2 style="color:var(--brand-primary); margin-top:0;">Version History</h2>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table class="changelog-table">
                    <tr><th>Version</th><th>Changes</th></tr>
                    <tr><td><span class="version-badge">v6.6</span></td><td>
                        ‚Ä¢ <strong>Application Mode:</strong> New toggle for 50/50 Vignette/Recall mix.<br>
                        ‚Ä¢ <strong>Compact UI:</strong> Settings re-arranged into a horizontal grid.<br>
                        ‚Ä¢ <strong>Refinements:</strong> "Imperial Style" is now always on. Fixed table borders.
                    </td></tr>
                    <tr><td><span class="version-badge">v6.5</span></td><td>
                        ‚Ä¢ <strong>Exclusions:</strong> Visual strikethrough (‚úï) for SBAQs.<br>
                        ‚Ä¢ <strong>Single View:</strong> Integrated bottom navigation.<br>
                        ‚Ä¢ <strong>UI Overhaul:</strong> Floating submit button, integrated toggle view button.
                    </td></tr>
                    <tr><td><span class="version-badge">v6.4</span></td><td>‚Ä¢ <strong>Analytics:</strong> Granular tracking.<br>‚Ä¢ <strong>Bug Fixes:</strong> "Wrong Option" placeholders fixed.</td></tr>
                    <tr><td><span class="version-badge">v6.3</span></td><td>‚Ä¢ <strong>HTML Export:</strong> Faster, cleaner download format.</td></tr>
                    <tr><td><span class="version-badge">v6.2</span></td><td>‚Ä¢ <strong>Strict Scope:</strong> Added negative constraints to prevent AI hallucinations.<br>‚Ä¢ <strong>Custom UI:</strong> Replaced native alerts with styled modals.<br>‚Ä¢ <strong>Onboarding:</strong> Added "How to Use" guide.</td></tr>
                    <tr><td><span class="version-badge">v6.1</span></td><td>‚Ä¢ <strong>State Saving:</strong> Fixed bug where changing tags wiped answers.<br>‚Ä¢ <strong>PDF Engine:</strong> Integrated html2pdf for printable exports.</td></tr>
                    <tr><td><span class="version-badge">v6.0</span></td><td>‚Ä¢ <strong>SRS:</strong> Spaced Repetition logic.<br>‚Ä¢ <strong>Exam Tools:</strong> Timer, Quick Nav Sidebar.<br>‚Ä¢ <strong>Tagging:</strong> Strict topic categorization.<br>‚Ä¢ <strong>0 SAQ Fix:</strong> Logic prevents SAQ generation if count is 0.</td></tr>
                    <tr><td><span class="version-badge">v5.4</span></td><td>‚Ä¢ <strong>SAQ Saving:</strong> SAQ answers/scores now saved to the Error Bank.<br>‚Ä¢ <strong>Filters:</strong> Toolbar added to Review Screen.<br>‚Ä¢ <strong>Auto-Expand:</strong> SAQ text areas grow automatically.</td></tr>
                    <tr><td><span class="version-badge">v5.3</span></td><td>‚Ä¢ <strong>The Golden Rule:</strong> "Scientific Accuracy required, but Scope restricted."<br>‚Ä¢ <strong>Context:</strong> AI knows general medical context but won't test it unless in slides.</td></tr>
                    <tr><td><span class="version-badge">v5.2</span></td><td>‚Ä¢ <strong>No Popups:</strong> Replaced all browser alerts with custom modals.<br>‚Ä¢ <strong>Layout:</strong> Preserved loading spinner positions.</td></tr>
                    <tr><td><span class="version-badge">v5.1</span></td><td>‚Ä¢ <strong>Prefix Stripping:</strong> Removes "A.", "B." from correct answers.<br>‚Ä¢ <strong>Scientific Accuracy:</strong> Prompt updated to differentiate enzyme substrates.</td></tr>
                    <tr><td><span class="version-badge">v5.0</span></td><td>‚Ä¢ <strong>SAQ Support:</strong> Added 10-Mark Multi-Part Questions.<br>‚Ä¢ <strong>Self-Marking:</strong> Users grade themselves via checkboxes.<br>‚Ä¢ <strong>Distractors:</strong> AI instructed to generate plausible wrong options.</td></tr>
                    <tr><td><span class="version-badge">v4.3</span></td><td>‚Ä¢ <strong>Export Errors:</strong> Downloads a "Revision Sheet" style text file.<br>‚Ä¢ <strong>Export History:</strong> Downloads a detailed log of every attempt.</td></tr>
                    <tr><td><span class="version-badge">v4.2</span></td><td>‚Ä¢ <strong>Additive Mixing:</strong> "Mix Errors" adds extra old questions.<br>‚Ä¢ <strong>Review Screen:</strong> Dedicated page to review mistakes with filters.<br>‚Ä¢ <strong>Loading UI:</strong> Improved UX text.</td></tr>
                    <tr><td><span class="version-badge">v4.1</span></td><td>‚Ä¢ <strong>"I Was Right":</strong> Retroactively mark VSAQ correct.<br>‚Ä¢ <strong>Word Counter:</strong> Live "0/4 words" counter for VSAQs.<br>‚Ä¢ <strong>Brain Restore:</strong> Restored full training data.</td></tr>
                    <tr><td><span class="version-badge">v4.0</span></td><td>‚Ä¢ <strong>Modern Dashboard:</strong> Home screen with stats.<br>‚Ä¢ <strong>Smart Mix:</strong> Toggle to mix old errors.<br>‚Ä¢ <strong>Exam Tools:</strong> Added Flag button and Sticky Score.<br>‚Ä¢ <strong>UX:</strong> Custom animated Result Modals.</td></tr>
                    <tr><td><span class="version-badge">v3.6</span></td><td>‚Ä¢ <strong>Model Rotation:</strong> Added rotation logic between Flash models to bypass rate limits.</td></tr>
                    <tr><td><span class="version-badge">v3.5</span></td><td>‚Ä¢ <strong>Answer Search:</strong> Code looks for answers in all possible JSON fields.<br>‚Ä¢ <strong>Explanations:</strong> Mandatory "Explanation:" fields for VSAQs.</td></tr>
                    <tr><td><span class="version-badge">v3.4</span></td><td>‚Ä¢ <strong>Forbidden Rule:</strong> "DO NOT generate True/False questions."<br>‚Ä¢ <strong>Rescue Logic:</strong> Extracts options if AI hides them in stem.<br>‚Ä¢ <strong>Error Feedback:</strong> Explicit error messages.</td></tr>
                    <tr><td><span class="version-badge">v3.3</span></td><td>‚Ä¢ <strong>Force List:</strong> Slices text blocks into separate options.<br>‚Ä¢ <strong>Smart Matching:</strong> Cleans user selection for better grading.<br>‚Ä¢ <strong>Clickable Areas:</strong> Entire white box clickable.</td></tr>
                    <tr><td><span class="version-badge">v3.2</span></td><td>‚Ä¢ <strong>JSON Safety Check:</strong> Detects hidden wrapper objects.<br>‚Ä¢ <strong>Crash Protection:</strong> Try...catch blocks for submission.<br>‚Ä¢ <strong>Missing Answer Handling:</strong> Defaults to placeholder.</td></tr>
                    <tr><td><span class="version-badge">v3.1</span></td><td>‚Ä¢ <strong>Native Support:</strong> JSZip/Mammoth for .pptx/.docx.<br>‚Ä¢ <strong>Media Mining:</strong> Unzips PowerPoint to extract images.<br>‚Ä¢ <strong>Context Aware:</strong> Sends slide text AND images.</td></tr>
                    <tr><td><span class="version-badge">v3.0</span></td><td>‚Ä¢ <strong>Upload Zone:</strong> Support for PDFs/Images.<br>‚Ä¢ <strong>Hybrid Input:</strong> Paste text AND upload files.<br>‚Ä¢ <strong>Base64 Processor:</strong> In-browser file conversion.</td></tr>
                    <tr><td><span class="version-badge">v2.1</span></td><td>‚Ä¢ <strong>Auto-Strip:</strong> Removes "A."/"B." from answer text.<br>‚Ä¢ <strong>Re-Labeling:</strong> Assigns fresh labels after shuffle.<br>‚Ä¢ <strong>Result:</strong> Clean option list display.</td></tr>
                    <tr><td><span class="version-badge">v2.0</span></td><td>‚Ä¢ <strong>Strict Blue Theme:</strong> Professional "Imperial Blue" UI.<br>‚Ä¢ <strong>Dark Mode:</strong> Sun/Moon toggle with memory.<br>‚Ä¢ <strong>Adaptive UI:</strong> High contrast adjustments.</td></tr>
                    <tr><td><span class="version-badge">v1.3</span></td><td>‚Ä¢ <strong>Massive Dataset:</strong> Hardcoded 25 example questions.<br>‚Ä¢ <strong>Model Support:</strong> Updated dropdowns.<br>‚Ä¢ <strong>Reset Tools:</strong> Added "Clear Logs" button.</td></tr>
                    <tr><td><span class="version-badge">v1.2</span></td><td>‚Ä¢ <strong>Hardcoded Examples:</strong> Embedded perfect examples.<br>‚Ä¢ <strong>Crash Prevention:</strong> Target stable API endpoints.<br>‚Ä¢ <strong>Style Toggle:</strong> Added "Use Imperial Style Guide".</td></tr>
                    <tr><td><span class="version-badge">v1.1</span></td><td>‚Ä¢ <strong>Automatic Logging:</strong> Questions saved in browser.<br>‚Ä¢ <strong>Error Tracking:</strong> Incorrect list.<br>‚Ä¢ <strong>Review Mode:</strong> Retry wrong answers.<br>‚Ä¢ <strong>Duplicate Check:</strong> Prevent repetition.</td></tr>
                    <tr><td><span class="version-badge">v1.0</span></td><td>‚Ä¢ <strong>Launch:</strong> Core SBAQ/VSAQ generation logic.<br>‚Ä¢ <strong>Prompt Engineering:</strong> Initial parameters.<br>‚Ä¢ <strong>Backend:</strong> Gemini API integration.<br>‚Ä¢ <strong>Controls:</strong> Quantity selectors.</td></tr>
                </table>
            </div>
            <button class="btn btn-primary" onclick="closeGenericModal()" style="margin-top:20px; width:100%;">Close</button>
        `;
        modal.style.display = 'flex';
    }

    function closeGenericModal() {
        document.getElementById('generic-modal').style.display = 'none';
    }
    
    // --- ADVANCED REVIEW FILTERING ---
    function openErrorReview() {
        const e = getErrors();
        if(!e.length) return showCustomAlert("Clean Slate", "No mistakes recorded yet! Go do some exams.");
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('review-screen').classList.remove('hidden');
        
        renderFilterButtons();
        applyFilters();
    }

    function renderFilterButtons() {
        let typeHTML = `<button class="btn btn-secondary btn-sm ${activeTypeFilters.length===VALID_TYPES.length?'active':''}" onclick="toggleTypeFilter('ALL')">All</button>`;
        VALID_TYPES.forEach(t => {
            typeHTML += `<button class="btn btn-secondary btn-sm ${activeTypeFilters.includes(t)?'active':''}" onclick="toggleTypeFilter('${t}')">${t}</button>`;
        });
        document.getElementById('filter-type-row').innerHTML = `<span class="filter-label">Types:</span> ${typeHTML}`;

        let tagHTML = `<button class="btn btn-secondary btn-sm ${activeTagFilters.length===VALID_TAGS.length?'active':''}" onclick="toggleTagFilter('ALL')">All</button>`;
        VALID_TAGS.forEach(t => {
            tagHTML += `<button class="btn btn-secondary btn-sm ${activeTagFilters.includes(t)?'active':''}" onclick="toggleTagFilter('${t}')">${t}</button>`;
        });
        document.getElementById('filter-tag-row').innerHTML = `<span class="filter-label">Topics:</span> ${tagHTML}`;
    }

    function toggleTypeFilter(val) {
        if(val === 'ALL') {
            if(activeTypeFilters.length === VALID_TYPES.length) activeTypeFilters = [];
            else activeTypeFilters = [...VALID_TYPES];
        } else {
            if(activeTypeFilters.includes(val)) activeTypeFilters = activeTypeFilters.filter(x => x !== val);
            else activeTypeFilters.push(val);
        }
        renderFilterButtons();
        applyFilters();
    }

    function toggleTagFilter(val) {
        if(val === 'ALL') {
            if(activeTagFilters.length === VALID_TAGS.length) activeTagFilters = [];
            else activeTagFilters = [...VALID_TAGS];
        } else {
            if(activeTagFilters.includes(val)) activeTagFilters = activeTagFilters.filter(x => x !== val);
            else activeTagFilters.push(val);
        }
        renderFilterButtons();
        applyFilters();
    }

    function applyFilters() {
        const allErrors = getErrors();
        const filtered = allErrors.filter(q => {
            const matchesType = activeTypeFilters.includes(q.type);
            const qTag = q.tag || "Uncategorized"; 
            const matchesTag = activeTagFilters.includes(qTag) || (activeTagFilters.length === VALID_TAGS.length); 
            return matchesType && matchesTag;
        });

        currentExamData = filtered; 
        if(filtered.length === 0) {
            document.getElementById('review-container').innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-sub);">No questions match current filters.</div>`;
        } else {
            renderExam(filtered, 'review-container', true, false);
        }
    }

    function clearLogs() { 
        showCustomConfirm("Clear History?", "This will wipe all exam stats and your mistake bank. Are you sure?", () => {
            localStorage.removeItem(HIST_KEY); 
            localStorage.removeItem(ERR_KEY); 
            updateStats();
        });
    }

    // --- HTML EXPORT FUNCTIONS (DOM ATTACHMENT FIX) ---

    function exportMistakesHTML() {
        const errs = getErrors();
        if(errs.length === 0) return showCustomAlert("Empty", "No mistakes to export.");

        let html = `<html><head><style>
            body { font-family: 'Segoe UI', sans-serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto; line-height: 1.6; }
            h1 { color: #002147; border-bottom: 2px solid #002147; padding-bottom: 10px; }
            .question-card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 30px; page-break-inside: avoid; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .badges { margin-bottom: 10px; font-size: 0.85em; }
            .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
            .badge-type { background: #e9ecef; color: #555; }
            .badge-tag { background: #d4af37; color: white; }
            .user-ans { color: #842029; font-weight: bold; }
            .correct-ans { color: #0f5132; font-weight: bold; }
            .explanation { background: #f8f9fa; padding: 15px; border-left: 4px solid #002147; margin-top: 15px; border-radius: 4px; }
            ul { margin: 5px 0; padding-left: 20px; }
        </style></head><body>
        <h1>PoM Mistake Bank</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>`;

        errs.forEach((e, i) => {
            let optionsHTML = '';
            if(e.type === 'SBAQ' && e.options) {
                optionsHTML = `<div><strong>Options:</strong><ul>${e.options.map(o => `<li>${o}</li>`).join('')}</ul></div>`;
            }

            let userAnsDisplay = e.userLastAnswer;
            if(Array.isArray(userAnsDisplay)) {
                userAnsDisplay = `<ol>` + userAnsDisplay.map(a => `<li>${a || '(No answer)'}</li>`).join('') + `</ol>`;
            } else if (!userAnsDisplay) {
                userAnsDisplay = "(No answer recorded)";
            }

            let correctDisplay = e.correctAnswer || (Array.isArray(e.acceptedAnswers) ? e.acceptedAnswers.join(', ') : '');
            let qTitle = e.question; // Default

            if (e.type === 'SAQ') {
                // FIX: SAQ Title Logic
                qTitle = e.intro || e.question || "Short Answer Question";
                if(e.parts) {
                    correctDisplay = `<div><strong>Model Answers:</strong><br>${e.parts.map((p,idx) => `<em>Part ${idx+1}:</em> ${p.model_answer.join('; ')}`).join('<br>')}</div>`;
                }
            }

            html += `
            <div class="question-card">
                <div class="badges">
                    <span class="badge badge-type">${e.type}</span>
                    <span class="badge badge-tag">${e.tag || 'Uncategorized'}</span>
                </div>
                <h3>${i+1}. ${qTitle}</h3>
                ${optionsHTML}
                <p><strong>You Answered:</strong> <span class="user-ans">${userAnsDisplay}</span></p>
                <p><strong>Correct Answer:</strong> <span class="correct-ans">${correctDisplay}</span></p>
                <div class="explanation"><strong>Explanation:</strong><br>${e.explanation}</div>
            </div>`;
        });

        html += `</body></html>`;
        const blob = new Blob([html], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'PoM_Mistake_Bank.html';
        a.click();
    }

    function exportHistoryHTML() {
        const hist = getHistory();
        if(hist.length === 0) return showCustomAlert("Empty", "No history to export.");

        let html = `<html><head><style>
            body { font-family: 'Segoe UI', sans-serif; padding: 40px; color: #333; max-width: 900px; margin: 0 auto; }
            h1 { color: #002147; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { background: #002147; color: white; text-align: left; padding: 12px; }
            td { border-bottom: 1px solid #ddd; padding: 10px; font-size: 0.9em; }
            tr:nth-child(even) { background-color: #f9f9f9; }
            .correct { color: #0f5132; font-weight: bold; background: #d1e7dd; padding: 2px 6px; border-radius: 4px; }
            .wrong { color: #842029; font-weight: bold; background: #f8d7da; padding: 2px 6px; border-radius: 4px; }
        </style></head><body>
        <h1>Full Exam History</h1>
        <table>
            <tr><th>Date</th><th>Type</th><th>Question</th><th>Result</th></tr>`;

        hist.forEach(h => {
             const dateStr = new Date(h.timestamp).toLocaleDateString();
             const resClass = h.isCorrect ? 'correct' : 'wrong';
             const resText = h.isCorrect ? 'Correct' : 'Wrong';
             
             html += `<tr>
                <td>${dateStr}</td>
                <td>${h.type}</td>
                <td>${h.question}</td>
                <td><span class="${resClass}">${resText}</span></td>
             </tr>`;
        });

        html += `</table></body></html>`;
        const blob = new Blob([html], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'PoM_Exam_History.html';
        a.click();
    }
</script>
</body>
</html>